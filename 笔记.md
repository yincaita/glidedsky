# 1.çˆ¬è™«åŸºç¡€1

![image-20210321211553360](ç¬”è®°.assets/image-20210321211553360.png)

å…¶æ¬¡ï¼Œå…³äº`_token`ï¼Œæ–°å¼€æµè§ˆå™¨(æ— ç—•)ä¼šå‘ç°è¿™ä¸ªå€¼æ˜¯ä¼šå˜åŒ–çš„



![image-20210321211708401](ç¬”è®°.assets/image-20210321211708401.png)

![image-20210321211834914](ç¬”è®°.assets/image-20210321211834914.png)



æ€è·¯ï¼šæ¯æ¬¡è¯·æ±‚å‰å…ˆè®¿é—®ç™»é™†ç•Œé¢è·å¾—tokenï¼Œå†å’Œemailã€passwordä¸€èµ·è¯·æ±‚ã€‚è¿™æ˜¯ä¸€ä¸ªå…¬å…±çš„è¿‡ç¨‹ï¼Œå°è£…æˆ env.pyã€‚

```python
"""
ç¯å¢ƒè®¾ç½®
"""
import requests
import re


class Env(object):
    # æ¯ç§’è·å–ä¸ªæ•° æœ€å¤š200 ä½†æ˜¯é åçš„å› ä¸ºæ—¶é—´å…³ç³» å¤šå°‘ä¼šé€Ÿåº¦å·®äº›
    ip_each = 30
    # è¯·æ±‚æ•°æ®
    login_data = {
        "email": "é‚®ç®±",
        "password": "å¯†ç ",
        "_token": ""
    }
    # apiçš„url
    proxy_api_url = "api_url xxx &getnum=" + str(ip_each)

    def __init__(self):
        # è¯·æ±‚å¤´
        self.headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/89.0.4389.90 Safari/537.36 "
        }
        # login_url
        self.login_url = "http://www.glidedsky.com/login"
        # ä½¿ç”¨session, è‡ªåŠ¨ä¿å­˜ç™»é™†åè·å–çš„cookie
        self.session = requests.session()

    # ç™»é™†è·å– _tokenå€¼
    def login(self):
        response = self.session.get(self.login_url, headers=self.headers)
        # æ­£åˆ™è§£æ, å°†_tokenå€¼è¿”å›
        self.login_data["_token"] = re.search('name="_token" value="(.*?)"', response.text).group(1)
        # ç™»é™†æ•°æ®é½å¤‡, æ­£å¼ç™»é™†
        self.session.post(self.login_url, data=self.login_data, headers=self.headers)
        # print(self.login_data["_token"])
        return self.session

    """
        å®æ—¶è·å–ä»£ç†ip: æŸå®æ‰¾çš„1å—æµ‹è¯•, 1sæœ€å¤šè·å–200æ¬¡api è¿™é‡Œè·å–60 æ„Ÿè§‰å‰é¢çš„é€Ÿåº¦å¿«äº›
        ['ip1:port1', 'ip2:port2']
        è¿‡æœŸåç”¨çš„åç›Šäº‘ ipæ•°é‡è®¡è´¹
    """
    def get_proxy(self):
        response = requests.get(self.proxy_api_url, self.headers)
        return response.text.split("\r\n")


if __name__ == '__main__':
    env = Env()
    # env.login()

    print(env.get_proxy())
```



## ç¬¬ä¸€é¢˜

```python
"""
çˆ¬è™«åŸºç¡€1
"""
from env import Env
from lxml import etree

# è°ƒç”¨å°è£…çš„ç™»é™†ç¯å¢ƒ
env = Env()
session = env.login()

# æœ‰äº†token, cookieç­‰ä¿¡æ¯, å°±èƒ½è®¿é—®çˆ¬è™«ä¸€é¡µé¢äº†
url = "http://www.glidedsky.com/level/web/crawler-basic-1"
response = session.get(url, headers=env.headers)
# è·å–æ¯ä¸€ä¸ªæ•°å­—æ¡†
html = etree.HTML(response.text)
div_list = html.xpath('//div[@class="col-md-1"]')
# å®šä¹‰ å’Œ
total = 0
for div in div_list:
    total += int(div.xpath('normalize-space(./text())'))

print(f"ç»“æœæ˜¯: {total}")
```



# 2.çˆ¬è™«åŸºç¡€2

ç™»é™†åŒä¸Šï¼Œè¿™æ¬¡éœ€è¦ç¿»é¡µï¼Œè¿™å°±éœ€è¦å¾ªç¯è·å–ä¸‹ä¸€é¡µçš„é“¾æ¥ã€‚

![image-20210322095155839](ç¬”è®°.assets/image-20210322095155839.png)



æ¯ä¸€é¡µè·å–æ•°æ®æ–¹å¼åŒ`çˆ¬è™«åŸºç¡€1`ï¼Œåªæ˜¯xpathè¯­æ³•æœ‰å·®åˆ«ã€‚

```python
"""
çˆ¬è™«åŸºç¡€2
"""
from env import Env
from lxml import etree
import re

# è°ƒç”¨å°è£…çš„ç™»é™†ç¯å¢ƒ
env = Env()
session = env.login()

# å®šä¹‰ å’Œ
total = 0
# è¿™æ¬¡éœ€è¦å¾ªç¯éå†æ¯ä¸€é¡µ
curr_page_url = "http://www.glidedsky.com/level/web/crawler-basic-2?page=1"
while True:
    response = session.get(curr_page_url, headers=env.headers)
    # è·å–æ¯ä¸€ä¸ªæ•°å­—æ¡†
    html = etree.HTML(response.text)
    div_list = html.xpath('//div[@class="card-body"]//div[@class="col-md-1"]')

    for div in div_list:
        total += int(div.xpath('normalize-space(./text())'))

    cur_page_num = re.search('page=(\\d+)', curr_page_url).group(1)
    print(f"å‰{cur_page_num}é¡µæ•°å­—å’Œä¸º: {total}")

    # æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µ
    next_page_btn = html.xpath('//ul[@class="pagination"]/li[last()]')[0]
    # å¦‚æœä¸‹ä¸€é¡µæŒ‰é’®æœ‰disabledæ ·å¼, å°±æ²¡æœ‰ä¸‹ä¸€é¡µ
    if next_page_btn.xpath('contains(@class, "disabled")'):
        break
    else:
        # æœ‰ä¸‹ä¸€é¡µ, ç»™ä¸‹ä¸€é¡µurlèµ‹å€¼
        curr_page_url = next_page_btn.xpath('./a/@href')[0]

print(f"ç»“æœæ˜¯: {total}")
```



# 3.IPå±è”½1

å…ˆç”¨å¥‡æ€ªçš„æ–¹æ³•è¾¾åˆ°ä¿®æ”¹ipçš„ç›®çš„ï¼Œå†è¿›å»æŸ¥çœ‹ä¸‹ç½‘é¡µç»“æ„ï¼ŒæŠŠxpathå…ˆè¡Œè®°å½•ä¸€éï¼Œåç»­æœ‰é”™å†æ”¹ã€‚ï¼ˆä»£ç†è·å–ç½‘é¡µå†…å®¹ä¹Ÿå¯ï¼‰

ç»“æœæ˜¯ï¼šé¡µé¢ç»“æ„å’Œçˆ¬è™«åŸºç¡€2ç›¸åŒã€‚

![image-20210322103330503](ç¬”è®°.assets/image-20210322103330503.png)



ç°åœ¨æœ€é‡è¦çš„å°±æ˜¯å¦‚ä½•è·å–1000å¤šä¸ªå¯ç”¨çš„ä»£ç†ipäº†ï¼Œæˆ‘ä»¬å»æŸå®éšä¾¿æ‰¾ä¸€ä¸ªä¾¿å®œçš„`é«˜åŒ¿ip`ã€‚

åœ¨env.pyçš„Envç±»ä¸­æ·»åŠ å¦‚ä¸‹æˆå‘˜æ–¹æ³•ï¼š

```python
	# æ¯ç§’è·å–ä¸ªæ•° æœ€å¤š200 ä½†æ˜¯é åçš„å› ä¸ºæ—¶é—´å…³ç³» å¤šå°‘ä¼šé€Ÿåº¦å·®äº›
    ip_each = 30
    
    # apiçš„url
    proxy_api_url = "api_url" + str(ip_each)
        
    """
        å®æ—¶è·å–ä»£ç†ip: æŸå®æ‰¾çš„1å—æµ‹è¯•, 1sæœ€å¤šè·å–200æ¬¡api è¿™é‡Œè·å–60 æ„Ÿè§‰å‰é¢çš„é€Ÿåº¦å¿«äº›
        ['ip1:port1', 'ip2:port2']
        è¿‡æœŸåç”¨çš„åç›Šäº‘ ipæ•°é‡è®¡è´¹
    """
    def get_proxy(self):
        response = requests.get(self.proxy_api_url, self.headers)
        return response.text.split("\r\n")
```

ç°åœ¨å°†ä¸Šä¸ª`çˆ¬è™«åŸºç¡€2`çš„ä»£ç è¿›è¡Œæ”¹é€ ï¼Œæ·»åŠ æ¯æ¬¡æ›´æ¢ä¸€ä¸ªä»£ç†è¿›è¡Œè¯·æ±‚ã€‚

```python
"""
ipåçˆ¬1
    ç»“æ„å’Œçˆ¬è™«åŸºç¡€ç›¸åŒ
"""
from env import Env
from lxml import etree
import re
import time

# è°ƒç”¨å°è£…çš„ç™»é™†ç¯å¢ƒ
env = Env()
session = env.login()

# å®šä¹‰ å’Œ
total = 0

# å½“å‰é¡µ
curr_page = 1

# ä»£ç†ipçš„ç´¢å¼•, å› ä¸ºæ¯1ç§’åªèƒ½è·å–æœ€å¤š200ä¸ªip
proxy_index = 0

# 200ä¸ªä»£ç†ipåˆ—è¡¨
proxy_list = env.get_proxy()

while True:
    # è¿™é‡Œé‡‡ç”¨ä»£ç† è¶…æ—¶è®¾ç½®ä¸º0.6s è®¾ç½®å°ä¸€ç‚¹ é‚£ä¹ˆæ…¢çš„ä»£ç†ipå°±è‡ªåŠ¨è·³è¿‡äº† ä½†æ˜¯åˆä¸èƒ½å¤ªå° æ¯•ç«Ÿä»£ç†æ¯”æ­£å¸¸è®¿é—®æ…¢ è·‘å®Œä¼°è®¡ä¹Ÿå¾—5-8åˆ†é’Ÿå·¦å³
    # å¦‚æœæŠ¥é”™/è¿”å›403é¡µé¢å°±ç”¨ä¸‹ä¸€ä¸ªä»£ç† æ³¨æ„ä»£ç†çš„ é”®æ˜¯http å†™æˆå¤§å†™ä»£ç†æ— æ•ˆ
    try:
        response = session.get(f"http://www.glidedsky.com/level/web/crawler-ip-block-1?page={curr_page}",
                               headers=env.headers, timeout=0.3, proxies={"http": proxy_list[proxy_index]})
        # é¡µé¢å“åº”403 åˆ™ä¹Ÿåº”ç®—é”™è¯¯
        if 403 == response.status_code:
            raise Exception(f"è¯¥ä»£ç†å·²ç»ç”¨è¿‡: {proxy_list[proxy_index]}")
    except Exception as e:
        # ç›´æ¥ä½¿ç”¨ä¸‹ä¸€ä¸ªçš„proxy
        proxy_index += 1
        if proxy_index >= env.ip_each:
            proxy_list = env.get_proxy()
            # *****
            proxy_index = 0
        continue

    # è·å–æ¯ä¸€ä¸ªæ•°å­—æ¡†
    html = etree.HTML(response.text)
    div_list = html.xpath('//div[@class="card-body"]//div[@class="col-md-1"]')

    print("-"*40)
    for div in div_list:
        total += int(div.xpath('normalize-space(./text())'))

    print(f"å‰{curr_page}é¡µæ•°å­—å’Œä¸º: {total}")
    if curr_page >= 1000:
        break
    curr_page += 1

print(f"ç»“æœæ˜¯: {total}")
```



# 4.IPå±è”½2

å› ä¸ºæ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ç”¨çš„æ–°ä»£ç†ipï¼Œä»£ç åŒ `ipå±è”½1`é¢˜ã€‚

ç»“æœï¼ˆå¤šå¾ªç¯äº†ä¸€æ¬¡ï¼Œcurr_page >1000 ä¹‹å‰æ²¡åŠ ä¸Š >=ï¼Œå¯¹ç»“æœæ²¡å½±å“ï¼‰ï¼š

![image-20210323125253519](ç¬”è®°.assets/image-20210323125253519.png)



# 5. å­—ä½“åçˆ¬1

çœ‹è¿‡é¢˜å¹¶åˆ†æè¿‡htmlä»£ç çš„åº”è¯¥éƒ½æ¸…é™¤ï¼Œæ¯æ¬¡åˆ·æ–°æºç ä¸­çš„æ•°å­—éƒ½æ˜¯å˜åŒ–çš„ï¼Œè€Œå®é™…æ˜¾ç¤ºå‡ºçš„æ•°å­—éƒ½æ²¡å˜åŒ–ã€‚
æœ‰å¿ƒçš„åŒå­¦åº”è¯¥æ¯”è¾ƒè¿‡æ¯æ¬¡åˆ·æ–°ç½‘é¡µåçš„base64ä¸²çš„å€¼ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸åŒçš„ï¼Œè¯´æ˜base64ä¸²åœ¨è¿™é‡Œæ‰¿è½½äº†å­—ä½“è½¬åŒ–çš„åŠŸèƒ½ã€‚
![åˆ·æ–°ç½‘é¡µåçš„base64ä¸²æ¯”è¾ƒ](ç¬”è®°.assets/20210324121837151.png)
æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹æ¯æ¬¡çš„base64ä¸²è¿›è¡Œåˆ†æï¼Œåœ¨è¿™é‡Œäº†è§£åˆ°äº†èƒ½å°†base64è½¬åŒ–ä¸º`ttf`æ–‡ä»¶ï¼Œå†åˆ©ç”¨ä»£ç è½¬ä¸º`xml`æ–‡ä»¶åšåˆ†æã€‚

æˆ‘ä»¬åœ¨`æµè§ˆå™¨`å†…(æ–¹ä¾¿åæœŸå¯¹æ¯”ç¡®è®¤ç»“æœ)ï¼Œè·å–base64ä¸²ï¼Œç”¨ä»£ç å°†å…¶è½¬ä¸º ttf å’Œ xml æ–‡ä»¶ã€‚



> **æ•°æ®é‡‡é›†è¿‡ç¨‹**

![æ‰“å¼€æ— ç—•çª—å£](ç¬”è®°.assets/20210324122404120.png)
è¿›å…¥é¡µé¢åF12ï¼Œæœç´¢`base64`ï¼Œè¿›å…¥ç•Œé¢å¤åˆ¶å€¼ã€‚
![æœç´¢](ç¬”è®°.assets/20210324122430205.png)
![å¤åˆ¶base64ä¸²](ç¬”è®°.assets/20210324122510392.png)
> ä»£ç éªŒè¯base64çš„ä¸å”¯ä¸€æ€§  å¹¶  è½¬åŒ–ttfã€xml
> **ttf_test.py**

```python
"""
å…³äºè½¬ç 
    https://blog.csdn.net/yishengzhiai005/article/details/80045042
    python2ä¸­è¿›è¡ŒBase64ç¼–ç å’Œè§£ç 
    python3ä¸å¤ªä¸€æ ·ï¼šå› ä¸º3.xä¸­å­—ç¬¦éƒ½ä¸ºunicodeç¼–ç ï¼Œè€Œb64encodeå‡½æ•°çš„å‚æ•°ä¸ºbyteç±»å‹ï¼Œæ‰€ä»¥å¿…é¡»å…ˆè½¬ç ã€‚
    
æµ‹è¯•base64è½¬ttfã€åˆ†ættfã€xmlæ–‡ä»¶
"""
from env import Env
import re
import base64
from fontTools.ttLib import TTFont

env = Env()
env.login()
session = env.session

url = "http://www.glidedsky.com/level/web/crawler-font-puzzle-1"

response = session.get(url, headers=env.headers)

# base64_str = re.search('base64,(.*?)[)]', response.text).group(1)

# æ‰“å°base64 è¯´æ˜æ¯æ¬¡çš„base64éƒ½æœ‰ä¸åŒä¹‹å¤„
# print(base64_str)
# è§£ç (base64å‚æ•°éƒ½æ˜¯unicodeç¼–ç åçš„ä¸², æ‰€ä»¥strå…ˆå¾—encode), è§£ç é’ˆå¯¹çš„æ˜¯base64_strç¼–ç æˆunicodeåçš„bytes

# ç›´æ¥ç”¨æˆ‘ä»¬æ— ç—•æµè§ˆå™¨å¤åˆ¶ä¸‹æ¥çš„base64ä¸²
base64_str = "è‡ªå·±è¡¥å…¨"
data = base64.b64decode(base64_str.encode())
# ç°åœ¨çš„dataä¾æ—§æ˜¯unicodeç¼–ç çš„bytesç±»å‹

# å†™å‡ºä¸º .ttf
with open('font-puzzle-1.ttf', 'wb') as f:
    f.write(data)

# å°†font-puzzle-1.ttfè½¬ä¸ºxmlæ–‡ä»¶
font = TTFont('font-puzzle-1.ttf')
font.saveXML('font-puzzle-1.xml')
```



> **ç¬¬ä¸€æ¬¡è·å–base64ä¸²**

å°†base64ä¸²èµ‹å€¼åˆ°ä»£ç ä¸­å˜é‡ `base64_str`ï¼Œè¿è¡Œç”Ÿæˆ ttf å’Œ xmlã€‚
å°†ttfç”¨fontstore[é“¾æ¥](http://font.qqe2.com/index.html)ï¼ˆæˆ–fontcreatorï¼‰æ‰“å¼€ï¼Œ
![fontstore](ç¬”è®°.assets/20210324123032189.png)

fontstoreæ‰“å¼€å¦‚ä¸‹å›¾ï¼š
![fontstoreæ‰“å¼€](ç¬”è®°.assets/2021032412322215.png)
fontcreatoræ‰“å¼€å¦‚ä¸‹ï¼š
![fontcreator](ç¬”è®°.assets/2021032412324425.png)
æˆ‘ä»¬å†æ‰“å¼€ xml è¿›è¡Œåˆ†æï¼Œæœç´¢`code`ç›¸å…³å†…å®¹ï¼Œå‘ç°å°±åªæœ‰ä»¥ä¸‹2å¤„æœ‰æ•ˆæ•°æ®(å’Œæ•°å­—ç›¸å…³çš„æ•°æ®)ã€‚
![GlyphOrder](ç¬”è®°.assets/20210324123409664.png)
![cmap](ç¬”è®°.assets/20210324123431269.png)
ç»“åˆ`xmlä¸­ä¸Šé¢2å›¾çš„æ˜ å°„å…³ç³»`å’Œ`fontstoreä¸­çš„`å°†æ•°æ®æ•´ç†æˆè¡¨æ ¼ï¼š
![è¡¨æ ¼1](ç¬”è®°.assets/20210324123641285.png)
çº¸é¢åˆ†æå®Œäº†ï¼Œè¿›è¡Œæµè§ˆå™¨å†…å®¹æ¯”è¾ƒï¼š
![æ¯”è¾ƒ1](ç¬”è®°.assets/20210324123714830.png)

æ¯”è¾ƒæµè§ˆå™¨æ˜¾ç¤ºï¼šè¯´æ˜å­—ä½“æ–‡ä»¶ï¼ˆttf/xmlï¼‰ä¸­çš„cmapä¸­çš„<font color=red>nameå€¼</font>å”¯ä¸€å¯¹åº”ä¸€ä¸ª<font color=red>å®é™…æ˜¾ç¤º</font>ã€‚å› ä¸ºè¡¨æ ¼ä¸­ï¼Œ"zero" --> 8ï¼Œ"one"  --> 5 ......ï¼Œåªæ˜¯æˆ‘åœ¨å›¾ä¸­ç”¨äº†æ•°å­—è¡¨ç¤ºã€‚



> **ç¬¬äºŒæ¬¡è·å–base64ä¸²**

é‡å¼€ä¸€ä¸ªæ— ç—•æµè§ˆå™¨ï¼Œè¿›è¡ŒåŒæ ·è®¿é—®ï¼Œè·å¾—ä¸€ä¸ªæ–°base64ä¸²ï¼Œç”¨ä»£ç ï¼ˆttf_test.pyï¼‰é‡æ–°ç”Ÿæˆttfå’Œxmlæ–‡ä»¶ï¼Œfontstore<font color=red>é‡æ–°</font>æ‰“å¼€ttfæ–‡ä»¶ã€‚

ç°åœ¨å…ˆå°±å¯ä»¥ä¸ç”¨å†åˆ†æxmlæ–‡ä»¶å†…å®¹äº†ï¼Œç»è¿‡ç¬¬ä¸€æ¬¡è§‚å¯Ÿï¼Œç›´æ¥çœ‹`fontstoreç»“æœ`å³å¯ï¼Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚
![2æ¬¡æµ‹è¯•æ¯”è¾ƒå›¾](ç¬”è®°.assets/20210324124455637.png)
é‡è¦ç»“è®ºï¼š<font color=red>nameå¯¹åº”codeä¸€ç›´éƒ½æ²¡æœ‰æ”¹å˜çš„ã€‚</font>æ‰€ä»¥ï¼Œæºç æ”¹å˜ï¼Œä½†æ˜¯å®é™…æ˜¾ç¤ºå†…å®¹ä¸å˜ï¼Œè‚¯å®šæ˜¯ `code --> å®é™…æ˜¾ç¤º`  è¿™ä¸€è¿‡ç¨‹çš„æ˜ å°„å‘ç”Ÿäº†å˜åŒ–ã€‚æ­£å¥½GlyphOrderæ˜ å°„æœ‰æ‰€æ”¹å˜ã€‚
![GlyphOrderæ”¹å˜äº†](ç¬”è®°.assets/20210324124705556.png)
ä¸‹é¢æ˜¯æ–°ä¸€è½®ç»Ÿè®¡çš„è¡¨æ ¼ï¼š
![ç»Ÿè®¡2](ç¬”è®°.assets/20210324124753712.png)
â€œzeroâ€ -->  5ï¼Œ"one"  -->  "7"ï¼Œ.....ã€‚



ç°åœ¨é ç¬¬äºŒæ¬¡çº¸é¢åˆ†æçš„ç»“æœï¼Œæˆ‘ä»¬æ¨æµ‹ï¼š![æ¨æµ‹æµè§ˆå™¨ä¸­çš„ç»“æœ](ç¬”è®°.assets/20210324124846194.png)





![æ¨æµ‹æˆåŠŸ](ç¬”è®°.assets/20210324124905736.png)

æ¨æµ‹<font color=red>æ­£ç¡®</font>ã€‚



> **æ€è€ƒ**

ç°åœ¨æˆ‘ä»¬èƒ½ä»xmlä¸­è·å–`name --> code` çš„æ˜ å°„ï¼ˆè¿™æ˜¯ä¸å˜çš„ï¼‰ï¼Œé‚£ä¹ˆ ä» `name --> å®é™…æ˜¾ç¤º` çš„æ˜ å°„æ€ä¹ˆåŠå‘¢?

ä»ç¬¬äºŒæ¬¡æµ‹è¯•ä¸­èƒ½å¾—å‡ºï¼šå®é™…æ˜¾ç¤ºçš„æ”¹å˜å°±å’Œ`GlyphOrder`çš„å˜åŒ–æœ‰å…³ï¼ˆå³IDå’Œnameçš„æ˜ å°„çš„æ”¹å˜ï¼‰ã€‚

å†åŠ ä¸Šå®é™…æ˜¾ç¤ºçš„ç»“æœï¼Œæˆ‘ä»¬æ¯”è¾ƒ2æ¬¡æµ‹è¯•ï¼Œè¡¨æ ¼ç»“æœçš„åŒºåˆ«ï¼š
![2æ¬¡è¡¨æ ¼çš„åŒºåˆ«](ç¬”è®°.assets/20210324125130974.png)
ä»xmlæ–‡ä»¶ä¸­å’Œ`"code"`æœ‰å…³çš„éƒ¨åˆ†å°±åªæœ‰`GlyphOrder`å’Œ`cmap`ï¼Œcmaçš„nameã€codeæˆ‘ä»¬å·²ç»ç”¨äº†ï¼Œä¹Ÿç”¨äº†GlyphOrderä¸­çš„nameï¼Œè¿˜æœ‰GlyphOrderä¸­çš„IDè§„å¾‹æˆ‘ä»¬æ²¡è€ƒè™‘åˆ°ã€‚

æˆ‘ä»¬è§‚å¯Ÿä¸Šé¢2å›¾ï¼Œå¾ˆè½»æ¾å°±èƒ½å‘ç° ==**ID-1 å°±ç­‰äº å®é™…æ˜¾ç¤º**==



> **å®ç°**

æ‰€ä»¥ä»£ç é€»è¾‘ä¹Ÿæœ‰äº†ï¼šè¯·æ±‚è·å–base64ï¼Œè½¬ä¸ºtffå†è½¬ä¸ºxmlï¼Œlxmlè§£æï¼Œï¼ˆèƒ½æ„å»ºcmapä¸­ `name --> code`ï¼Œä½†æˆ‘ä»¬åªå…³å¿ƒ`name-->ID`ï¼‰ï¼Œå†æ„å»ºGlyphOrderä¸­  `name --> ID`çš„æ˜ å°„ã€‚å¾—åˆ°äº†nameï¼Œ**nameå…¶å®å°±æ˜¯æµè§ˆå™¨æºç ä¸­æèµ·å‡ºæ¥çš„æ•°å­—ï¼Œè½¬åŒ–ä¸ºIDï¼Œå†å‡ä¸€ï¼Œå°±æˆäº†çœŸå®æ•°æ®äº†**ã€‚ä½†æ˜¯nameä¸­ `'zero'`éœ€è¦å˜ä¸º`0`ï¼Œæ–¹ä¾¿åæœŸç›´æ¥è¿›è¡Œé¡µé¢å†…å®¹è½¬åŒ–ä¸ºçœŸå®ç»“æœã€‚



> ä»£ç å¦‚ä¸‹

```python
from env import Env
import re
import base64
from fontTools.ttLib import TTFont
from lxml import etree
import io

# æ•°å­—-è‹±è¯­ æ˜ å°„
english_map = {
    '0': 'zero', '1': 'one', '2': 'two',
    '3': 'three', '4': 'four', '5': 'five',
    '6': 'six', '7': 'seven', '8': 'eight', '9': 'nine'
}

"""
å°†æºç ä¸­çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºçœŸå®çš„æ•°å­—
    src_str: å¦‚'231' --> 567  '23' --> 56  '1' --> 7
    digit_map: æºç æ•°å­— --> çœŸå®æ•°å­— çš„æ˜ å°„ {"zero": see_num1, "one": see_num2, ...}
    è¿”å›: çœŸå®æ•°å­—
"""
def parse_srcstr_realnum(src_str, digit_map):
    # åˆ†è§£å‡ºæ¯ä¸€ä½å­—ç¬¦ æ³¨æ„ joinå‚æ•°å¿…é¡»ä¸ºå­—ç¬¦ä¸²
    return int(''.join(str(digit_map[english_map[ch]]) for ch in src_str))


"""
è·å–ä»æºç ä¸­çš„æ•°å­—åˆ°è§åˆ°çš„æ•°å­—çš„æ˜ å°„
    è¿”å›: å½“å‰é¡µå“åº”, å½“å‰é¡µçš„æ•°å­—æ˜ å°„
"""
def get_response_and_digitmap(page):
    url = f"http://www.glidedsky.com/level/web/crawler-font-puzzle-1?page={page}"

    response = session.get(url, headers=env.headers)

    base64_str = re.search('base64,(.*?)[)]', response.text).group(1)

    # è§£ç (base64å‚æ•°éƒ½æ˜¯unicodeç¼–ç åçš„ä¸², æ‰€ä»¥strå…ˆå¾—encode), è§£ç é’ˆå¯¹çš„æ˜¯base64_strç¼–ç æˆunicodeåçš„bytes
    data = base64.b64decode(base64_str.encode())
    # ç°åœ¨çš„dataä¾æ—§æ˜¯unicodeç¼–ç çš„bytesç±»å‹, è½¬åŒ–ä¸ºioæµ, é¿å…å†™æ–‡ä»¶è¿‡ç¨‹
    fio = io.BytesIO(data)
    font = TTFont(fio)
    glyph_order = font.getGlyphOrder()
    # æ•°å­—æ˜ å°„ {"æºç ä¸­çš„æ•°å­—": "å®é™…çœ‹åˆ°çš„æ•°å­—", ...}
    digit_map = {}
    # è§£æGlyphOrderä¸­çš„<GlyphID id="" name=""> å¹¶ç»„æˆ {"zero": "see_num1", "one": "see_num2", ...}
    for glyph_name in glyph_order:
        digit_map[glyph_name] = str(font.getGlyphID(glyph_name) - 1)

    print('æºç æ•°å­— -> å¯è§æ•°å­—: ', digit_map)
    return digit_map, response


"""
è·å–å½“å‰é¡µçœŸå®çš„æ•°å­—å’Œ, ä¸€æ¬¡è¯·æ±‚ä¸€é¡µ, ä¸€é¡µå†…çš„æ•°å­— æ˜ å°„ä¸ä¼šå˜çš„
    page: ç¬¬å‡ é¡µæ•°æ®
"""
def get_page_sum(page):
    digit_map, response = get_response_and_digitmap(page)
    # è·å–æ¯ä¸€ä¸ªæ•°å­—æ¡†
    html = etree.HTML(response.text)
    div_list = html.xpath('//div[@class="card-body"]//div[@class="col-md-1"]')

    # æ¯é¡µå’Œ
    page_total = 0
    for div in div_list:
        # ä¸€ä¸ªæ•°å­—ä¸²
        s = str(div.xpath('normalize-space(./text())'))
        # åˆ†åˆ«è§£æ, å¦‚'231' -> 231
        page_total += parse_srcstr_realnum(s, digit_map)

    return page_total


env = Env()
env.login()
session = env.session

# æ€»å’Œ
total = 0
# å®šä¹‰å’Œ
for page_num in range(1, 1001):
    total += get_page_sum(page_num)
    print(f'å‰ {page_num} é¡µå’Œä¸º {total}')
```



# 6.å­—ä½“åçˆ¬2

åŸç†åŒ`å­—ä½“åçˆ¬1`ï¼Œä½†æ˜¯ç°åœ¨ä»æµè§ˆå™¨è·å–çš„å†…å®¹ä¸æ˜¯æ•°å­—äº†ï¼Œè€Œæ˜¯æ±‰å­—ï¼Œå¹¶ä¸”xmlä¸­campçš„nameå€¼ä¹Ÿå¹¶æ²¡æœ‰åƒ "zero"ã€"one"çš„æç¤ºäº†ï¼Œæ‰€ä»¥ä¹‹å‰å­˜åœ¨çš„ english_map ç°åœ¨éœ€è¦ç”±æˆ‘ä»¬è‡ªå·±æ„å»ºäº†ï¼ŒåŸæ¥english_mapæ˜¯ "1" -> "zero" çš„æ˜ å°„ï¼ˆè¿™æˆ‘ä»¬æ˜¯ç†ŸçŸ¥çš„ï¼‰ï¼Œä½†ç°åœ¨æˆ‘ä»¬éœ€è¦ "æºç ä¸­æ±‰å­—" -> "name" çš„æ˜ å°„ã€‚

![æ²¡æœ‰æç¤º](ç¬”è®°.assets/image-20210325144159899.png)



> æµ‹è¯•getè¯·æ±‚è·å–çš„å†…å®¹ï¼Œç¼–ç å‰å’Œç¼–ç åçš„å†…å®¹ï¼Œå¹¶ç”Ÿæˆttfå’Œxml
>
> ç”¨æµè§ˆå™¨èƒ½å¾—åˆ°base64å’Œæ˜¾ç¤ºæƒ…å†µï¼Œåˆ†æ  "æºç æ±‰å­—"  -->  "å®é™…æ˜¾ç¤º" çš„è¿‡ç¨‹ã€‚

æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼ˆtest_ttf.pyï¼‰ï¼š

```python
import base64
from fontTools.ttLib import TTFont

# æµè§ˆå™¨å¤åˆ¶base64ä¸² ä¿æŒç½‘é¡µä¸åˆ·æ–° åˆ†æåŒä¸€é¡µçš„æ•°æ®
base64_str = "æµè§ˆå™¨æºç é‡Œå¤åˆ¶"
data = base64.b64decode(base64_str.encode())
# ç°åœ¨çš„dataä¾æ—§æ˜¯unicodeç¼–ç çš„bytesç±»å‹

# å†™å‡ºä¸º .ttf
with open('font-puzzle-2.ttf', 'wb') as f:
    f.write(data)

# å°†font-puzzle-2.ttfè½¬ä¸ºxmlæ–‡ä»¶
font = TTFont('font-puzzle-2.ttf')
font.saveXML('font-puzzle-2.xml')
```



ç”¨fontstoreæ‰“å¼€ttfæ–‡ä»¶ï¼Œåªåˆ†æ 0 - 9ã€‚

![image-20210325161706950](ç¬”è®°.assets/image-20210325161706950.png)

æµè§ˆå™¨ä¸­å®é™…æ˜¾ç¤ºä¸ºâ€œé›¶â€çš„æƒ…å†µä¸‹ï¼š

![image-20210325162105687](ç¬”è®°.assets/image-20210325162105687.png)

å¯¹åº”æºç æ±‰å­—ä¸ºï¼šâ€œé’¡â€ï¼Œç»è¿‡ç«™é•¿å·¥å…·è®¡ç®—ï¼Œâ€œé’¡â€çš„unicodeç¼–ç ä¸ºï¼š"\u94a1"

![image-20210325162148872](ç¬”è®°.assets/image-20210325162148872.png)

æˆ‘ä»¬å†åœ¨xmlæ–‡ä»¶ä¸­æœç´¢â€œé’¡â€çš„unicodeç¼–ç ï¼Œç»“åˆxmlä¸­cmapçš„å†…å®¹ï¼Œæˆ‘ä»¬ç›´æ¥æœç´¢"uni94a1"ï¼Œæ€»å…±2ä¸ªç»“æœã€‚

![image-20210325162439811](ç¬”è®°.assets/image-20210325162439811.png)



åœ¨æµè§ˆå™¨ä¸­å®é™…æ˜¾ç¤ºä¸ºâ€œâ‘ â€çš„æƒ…å†µä¸‹ï¼Œ

![image-20210325162932406](ç¬”è®°.assets/image-20210325162932406.png)

è€Œâ€œæˆâ€å­—å¯¹åº”çš„unicodeç¼–ç ä¸ºâ€œ\u6210â€ï¼Œå‚ç…§cmapä¸­nameçš„å€¼ï¼Œæˆ‘ä»¬åœ¨xmlä¸­æœç´¢â€œuni6210â€ã€‚

![image-20210325163133996](ç¬”è®°.assets/image-20210325163133996.png)



æ ¹æ®ä»¥ä¸Š2æ¬¡æµ‹è¯•ï¼Œå¹¶æ ¹æ®`å­—ä½“åçˆ¬1`çš„ç»“æœï¼Œå¾ˆæ˜æ˜¾èƒ½çœ‹å‡º

```
name = "uni" + "æºç æ±‰å­—çš„unicodeç¼–ç  å»é™¤\u"
æ ¹æ®è¿™ä¸ªnameå¯¹åº”çš„IDï¼Œå†å‡1ï¼Œç»“æœå°±æ˜¯å®é™…çš„æ•°å­—ã€‚
```



> ä»£ç é€»è¾‘

å…ˆæ ¹æ®GlyphOrderæ„å»º {"name1": "id", "name2", "id2"...} çš„å­—å…¸ï¼Œä¹‹åå†è·å–åˆ°"æºç æ±‰å­—"ï¼Œå°†æ±‰å­—è¿›è¡Œåˆ‡å‰²åï¼Œå–æ¯ä¸€ä½çš„unicodeç ï¼ˆå°±æ˜¯nameï¼‰ï¼Œä»¥unicodeç ä¸ºé”®ï¼Œä»å­—å…¸ä¸­å–idï¼Œidå†å‡1å°±æ˜¯ç”¨æˆ·çœ‹åˆ°çš„æ•°å­—ã€‚

> ä»£ç 

```python
from env import Env
import re
import base64
from fontTools.ttLib import TTFont
from lxml import etree
import io


"""
å°†æºç ä¸­çš„æ±‰å­—è½¬åŒ–ä¸ºçœŸå®çš„æ•°å­—
    src_str: å¦‚'éšæˆæˆ' --> 211
    uni_map: æºç æ±‰å­— --> çœŸå®æ•°å­— çš„æ˜ å°„ {"æˆ": 1, "éš": 2, ...}
    è¿”å›: çœŸå®æ•°å­—
"""
def parse_srcstr_realnum(src_str, uni_map):
    arr = []
    for ch in src_str:
        # æ¯ä¸ªchéƒ½æ˜¯ä¸€ä¸ªæ±‰å­—, å°†æ±‰å­—è½¬ä¸ºunicodeç¼–ç , å»é™¤ä¸²é¦–çš„\uå³ä¸ºéœ€è¦çš„ç¼–ç 
        uni = ch.encode('unicode-escape').decode()
        code = uni.replace('\\u', '')
        arr.append(uni_map[code])

    return int(''.join(arr))

"""
è·å–ä»æºç ä¸­çš„æ±‰å­—åˆ°è§åˆ°çš„æ•°å­—çš„æ˜ å°„
    è¿”å›: å½“å‰é¡µå“åº”, name(unicodeå»é™¤'uni')->çœŸå®æ•°å­— çš„æ˜ å°„ å¦‚, (response, {'7bd9': '0', '9716': '1', ...})
"""
def get_response_and_unimap(page):
    url = f"http://www.glidedsky.com/level/web/crawler-font-puzzle-2?page={page}"

    response = session.get(url, headers=env.headers)

    base64_str = re.search('base64,(.*?)[)]', response.text).group(1)

    # è§£ç (base64å‚æ•°éƒ½æ˜¯unicodeç¼–ç åçš„ä¸², æ‰€ä»¥strå…ˆå¾—encode), è§£ç é’ˆå¯¹çš„æ˜¯base64_strç¼–ç æˆunicodeåçš„bytes
    data = base64.b64decode(base64_str.encode())

    # ç°åœ¨çš„dataä¾æ—§æ˜¯unicodeç¼–ç çš„bytesç±»å‹, è½¬åŒ–ä¸ºioæµ, é¿å…å†™æ–‡ä»¶è¿‡ç¨‹
    fio = io.BytesIO(data)
    font = TTFont(fio)
    glyph_order = font.getGlyphOrder()
    # xmlä¸­ï¼šname->IDæ˜ å°„ {"unicode": "id-1", ...} æ³¨æ„è¿™é‡Œçš„unicodeæœ€å¥½æŠŠå‰ç¼€uniå»æ‰, å¹¶å­—æ¯å°å†™åŒ–
    name_id_map = {}
    # è§£æGlyphOrderä¸­çš„<GlyphID id="" name=""> å¹¶ç»„æˆ {"unicode1": "see_num1", "unicode2": "see_num2", ...}
    for glyph_name in glyph_order:
        name_id_map[str(glyph_name).replace('uni', '').lower()] = str(font.getGlyphID(glyph_name) - 1)

    print('æºç æ±‰å­—unicodeç  -> å¯è§æ•°å­—: ', name_id_map)
    return name_id_map, response


"""
è·å–å½“å‰é¡µçœŸå®çš„æ•°å­—å’Œ, ä¸€æ¬¡è¯·æ±‚ä¸€é¡µ, ä¸€é¡µå†…çš„æ•°å­— æ˜ å°„ä¸ä¼šå˜çš„
    page: ç¬¬å‡ é¡µæ•°æ®
"""
def get_page_sum(page):
    uni_map, response = get_response_and_unimap(page)
    # è·å–æ¯ä¸€ä¸ªæ•°å­—æ¡†
    html = etree.HTML(response.text)
    div_list = html.xpath('//div[@class="card-body"]//div[@class="col-md-1"]')

    # æ¯é¡µå’Œ
    page_total = 0
    for div in div_list:
        # ä¸€ä¸ªæ•°å­—ä¸²
        s = str(div.xpath('normalize-space(./text())'))
        # åˆ†åˆ«è§£æ, å¦‚'231' -> 231
        page_total += parse_srcstr_realnum(s, uni_map)

    return page_total


env = Env()
env.login()
session = env.session

# æ€»å’Œ
total = 0
# å®šä¹‰å’Œ
for page_num in range(1, 1001):
    total += get_page_sum(page_num)
    print(f'å‰ {page_num} é¡µå’Œä¸º {total}')
```



ä¸Šé¢çš„æ€è·¯åŠä»£ç å…¶å®æœ‰è¯¯ï¼Œä¼šåœ¨ä» uni_map ä¸­å–å€¼çš„æ—¶å€™ä¼šæŠ¥é”™(KeyError)ã€‚

ä¿®æ”¹ä»£ç ä¸ºå¦‚ä¸‹ï¼Œè¿›è¡Œè°ƒè¯•ï¼š

â‘ ï¼šå‡ºé”™ä½ç½®æ·»åŠ try...except

```python
def parse_srcstr_realnum(src_str, uni_map):
    arr = []
    for ch in src_str:
        # æ¯ä¸ªchéƒ½æ˜¯ä¸€ä¸ªæ±‰å­—, å°†æ±‰å­—è½¬ä¸ºunicodeç¼–ç , å»é™¤ä¸²é¦–çš„\uå³ä¸ºéœ€è¦çš„ç¼–ç 
        uni = ch.encode('unicode-escape').decode()
        code = uni.replace('\\u', '')
        try:
            arr.append(uni_map[code])
        except Exception as e:
            print(e)

    return int(''.join(arr))
```

â‘¡ï¼šè·å–responseä¹‹åï¼Œæˆ‘ä»¬æ·»åŠ å°†base64å†™å…¥ttfå’Œxmlçš„è¿‡ç¨‹ã€‚ï¼ˆç›®çš„æ˜¯ä¿è¯å‡ºé”™æ—¶æˆ‘ä»¬èƒ½æŸ¥çœ‹xmlï¼Œåˆ†æä¸ºä»€ä¹ˆæ²¡æœ‰å¯¹åº”çš„unicodeç¼–ç çš„nameå€¼ï¼‰

```python
# è§£ç (base64å‚æ•°éƒ½æ˜¯unicodeç¼–ç åçš„ä¸², æ‰€ä»¥strå…ˆå¾—encode), è§£ç é’ˆå¯¹çš„æ˜¯base64_strç¼–ç æˆunicodeåçš„bytes
    data = base64.b64decode(base64_str.encode())
    # å†™å‡ºä¸º .ttf
    with open('./font-puzzle-test2/font-puzzle-2.ttf', 'wb') as f:
        f.write(data)
    # å°†font-puzzle-2.ttfè½¬ä¸ºxmlæ–‡ä»¶
    font = TTFont('./font-puzzle-test2/font-puzzle-2.ttf')
    font.saveXML('./font-puzzle-test2/font-puzzle-2.xml')

    # ç°åœ¨çš„dataä¾æ—§æ˜¯unicodeç¼–ç çš„bytesç±»å‹, è½¬åŒ–ä¸ºioæµ, é¿å…å†™æ–‡ä»¶è¿‡ç¨‹
    fio = io.BytesIO(data)
    font = TTFont(fio)
    glyph_order = font.getGlyphOrder()
```

å¼€å§‹è°ƒè¯•ï¼š

![image-20210325174518849](ç¬”è®°.assets/image-20210325174518849.png)

è¿™æ—¶æ•°æ®å·²ç»åˆ·æ–°åˆ°ttfã€xmlæ–‡ä»¶ä¸­äº†ï¼Œæˆ‘ä»¬è¿›xmlæ–‡ä»¶è¿›è¡ŒæŸ¥çœ‹ï¼š

![image-20210325174557506](ç¬”è®°.assets/image-20210325174557506.png)

æœ€åéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼š

![image-20210325191833734](ç¬”è®°.assets/image-20210325191833734.png)

> ä¿®æ”¹åçš„ä»£ç 

```python
from env import Env
import re
import base64
from fontTools.ttLib import TTFont
from lxml import etree
import io


"""
å°†æºç ä¸­çš„æ±‰å­—è½¬åŒ–ä¸ºçœŸå®çš„æ•°å­—
    src_str: å¦‚'éšæˆæˆ' --> 211
    uni_map: æºç æ±‰å­— --> çœŸå®æ•°å­— çš„æ˜ å°„ {"æˆ": 1, "éš": 2, ...}
    è¿”å›: çœŸå®æ•°å­—
"""
def parse_srcstr_realnum(src_str, uni_map):
    arr = []
    for ch in src_str:
        # æ¯ä¸ªchéƒ½æ˜¯ä¸€ä¸ªæ±‰å­—, å°†æ±‰å­—è½¬ä¸ºunicodeç¼–ç , å»é™¤ä¸²é¦–çš„\uå³ä¸ºéœ€è¦çš„ç¼–ç 
        uni = ch.encode('unicode-escape').decode()
        code = uni.replace('\\u', '')
        arr.append(uni_map[code])

    return int(''.join(arr))

"""
è·å–ä»æºç ä¸­çš„æ±‰å­—åˆ°è§åˆ°çš„æ•°å­—çš„æ˜ å°„
    è¿”å›: å½“å‰é¡µå“åº”, name(unicodeå»é™¤'uni')->çœŸå®æ•°å­— çš„æ˜ å°„ å¦‚, (response, {'7bd9': '0', '9716': '1', ...})
"""
def get_response_and_unimap(page):
    url = f"http://www.glidedsky.com/level/web/crawler-font-puzzle-2?page={page}"

    response = session.get(url, headers=env.headers)

    base64_str = re.search('base64,(.*?)[)]', response.text).group(1)

    # è§£ç (base64å‚æ•°éƒ½æ˜¯unicodeç¼–ç åçš„ä¸², æ‰€ä»¥strå…ˆå¾—encode), è§£ç é’ˆå¯¹çš„æ˜¯base64_strç¼–ç æˆunicodeåçš„bytes
    data = base64.b64decode(base64_str.encode())

    # ç°åœ¨çš„dataä¾æ—§æ˜¯unicodeç¼–ç çš„bytesç±»å‹, è½¬åŒ–ä¸ºioæµ, é¿å…å†™æ–‡ä»¶è¿‡ç¨‹
    fio = io.BytesIO(data)
    font = TTFont(fio)
    glyph_order = font.getGlyphOrder()
    # cmapçš„ç»“æ„ { code: name, ... }  æ³¨æ„: cmapä¸­çš„codeæ˜¯10è¿›åˆ¶
    cmap = font.getBestCmap()
    name_id_map = {}
    # è§£æGlyphOrderä¸­çš„<GlyphID id="" name=""> å¹¶ç»„æˆ { "name": "id-1"... }
    for glyph_name in glyph_order:
        # ç°åœ¨è¿˜åªæ˜¯ name: id æ˜ å°„
        name_id_map[glyph_name] = str(font.getGlyphID(glyph_name) - 1)
    # å®šä¹‰ code_id_map {code: id, ...}
    code_id_map = {}
    # éå†cmap, å¾—åˆ° code_ip_map {code: id}
    for code in cmap:
        # å°†codeè½¬åŒ–ä¸º16è¿›åˆ¶
        code_id_map[hex(code).replace('0x', '')] = name_id_map[cmap[code]]

    print('æºç æ±‰å­—unicodeç  -> å¯è§æ•°å­—: ', code_id_map)
    return code_id_map, response


"""
è·å–å½“å‰é¡µçœŸå®çš„æ•°å­—å’Œ, ä¸€æ¬¡è¯·æ±‚ä¸€é¡µ, ä¸€é¡µå†…çš„æ•°å­— æ˜ å°„ä¸ä¼šå˜çš„
    page: ç¬¬å‡ é¡µæ•°æ®
"""
def get_page_sum(page):
    uni_map, response = get_response_and_unimap(page)
    # è·å–æ¯ä¸€ä¸ªæ•°å­—æ¡†
    html = etree.HTML(response.text)
    div_list = html.xpath('//div[@class="card-body"]//div[@class="col-md-1"]')

    # æ¯é¡µå’Œ
    page_total = 0
    for div in div_list:
        # ä¸€ä¸ªæ•°å­—ä¸²
        s = str(div.xpath('normalize-space(./text())'))
        # åˆ†åˆ«è§£æ, å¦‚'231' -> 231
        page_total += parse_srcstr_realnum(s, uni_map)

    return page_total


env = Env()
env.login()
session = env.session

# æ€»å’Œ
total = 0
# å®šä¹‰å’Œ
for page_num in range(1, 1001):
    total += get_page_sum(page_num)
    print(f'å‰ {page_num} é¡µå’Œä¸º {total}')
```



# 7.CSSåçˆ¬-1

æ¯æ¬¡åˆ·æ–°classéƒ½ä¼šé‡ç½®ï¼ŒæŒ‘å…¶ä¸­ä¸€æ¬¡åˆ†æï¼Œæ¯æ¬¡åˆ†æçš„æ—¶å€™çš„csséƒ½è¦åŒ¹é…æœ¬æ¬¡æ˜¾ç¤ºçš„é¡µé¢ã€‚



> ä»¥ä¸‹åˆ†ææœ‰é”™ï¼â‘ å¯ä»¥é€‰æ‹©ä¸çœ‹ï¼Œç›´æ¥çœ‹é”™è¯¯åˆ†æ + é‡æ–°è®¨è®ºã€‚â‘¡é€‰æ‹©çœ‹é”™è¯¯çš„åˆ†ç±»è®¨è®ºï¼Œçœ‹ä¸‹å¦‚ä½•çŠ¯é”™çš„ã€‚

```markdown
# åˆ†ç±»è®¨è®º(å–äº†å°‘æ•°å‡ ä¸ªä¾‹å­):

  ## div.col-md-1 å†…åªæœ‰ä¸€ä¸ªdiv(::before) ç›´æ¥è·å–contentå³ä¸ºå…·ä½“å†…å®¹
	.Lg20BXy { float:left } .Lg20BXy:before { content:"256" } .Lg20BXy { letter-spacing:0.4em }

  ## div.col-md-1 å†…æœ‰4ä¸ªdiv æœ‰1ä¸ªdivçš„classä¸ºé€æ˜ å¦‚æºç ä¸­ä¸º 9 6 7 2  å®é™…æ˜¾ç¤ºä¸º 276
	9: .mk0GYspY { float:left } .mk0GYspY { width:1em } .mk0GYspY { margin-right:-1em }   .mk0GYspY { opacity:0 }
	6: .kXr1Xjjpn { position:relative } .kXr1Xjjpn { float:left } .kXr1Xjjpn { width:1em } .kXr1Xjjpn { left:2em }
	7: .Miuk2yGt { float:left }  .Miuk2yGt { width:1em }
	2: .sX3iaG { position:relative } .sX3iaG { float:left } .sX3iaG { width:1em } .sX3iaG { left:-2em }
  è§„å¾‹ï¼šé¡ºåºéå†, left:2em > 0 å°±åœ¨''æœ«å°¾æ’å…¥, left:-2em < 0 å°±åœ¨ ''å¼€å¤´æ’å…¥, ä¸å­˜åœ¨'left:'å’Œ'opacity:0', å°±ç›´æ¥ä¿æŒ''æœ«å°¾æ’å…¥

  ## div.col-md-1 å†…æœ‰3ä¸ªdiv(æ­£å¸¸æƒ…å†µ) å¦‚æºç ä¸­ä¸º 2 9 4  å®é™…æ˜¾ç¤ºä¸º294, è¿™ç§ç›´æ¥æå–å³å¯
	2: .pRwyq22qBP { float:left } .pRwyq22qBP { width:1em }
	9: .fyM23XHiCE { float:left } .fyM23XHiCE { width:1em }
	4: .BTYOy24xKA { float:left } .BTYOy24xKA { width:1em }
  è§„å¾‹: æŒ‰ç…§ç¬¬äºŒç§æƒ…å†µå³å¯ï¼ˆç›¸å½“äºç¬¬äºŒç§æƒ…å†µä¸­: æ‰€æœ‰æ•°å­—éƒ½æ˜¯ 7 ï¼‰

  ## div.col-md-1 å†…æœ‰2ä¸ªdiv æœ‰ä¸€ä¸ªdiv**åŒ…å«æ•°å­—**ä½†ä¼šè®¾ç½®å®Œå…¨é€æ˜ï¼Œå¦ä¸€ä¸ªdivä½¿ç”¨::beforeæ·»åŠ content, è¿™ä¸ªdivçš„æƒ…å†µå°±å’Œç¬¬1ç§æƒ…å†µç›¸åŒäº†
```

ç»¼ä¸Šï¼Œâ‘ å’Œâ‘£å¯ä»¥åˆå¹¶ä¸ºï¼Œdiv.col-md-1å†…éƒ¨åªè¦æœ‰div.xpath('./div/text()')ä¸ºç©ºå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªdivå†…éƒ¨å°±å¿…å®šæ˜¯ä½¿ç”¨äº†ä¼ªå…ƒç´ é€‰æ‹©å™¨ï¼Œæˆ‘ä»¬å°±èƒ½ç›´æ¥è·å–contentã€‚

â‘¡å’Œâ‘¢ä¹Ÿå¯ä»¥åˆå¹¶ï¼šâ‘¡ä¸ç®¡é€æ˜çš„é‚£ä¸ªå…ƒç´ åï¼Œå°±å˜ä¸ºäº†â‘¢è¿™ç§æƒ…å†µäº†ã€‚

è‡³äºç”Ÿæˆçš„styleç›´æ¥ä»æºç çš„<style>ä¸­è·å–å³å¯ï¼Œç”¨æ­£åˆ™éªŒè¯å…·ä½“çš„å€¼å­˜ä¸å­˜åœ¨ã€‚



>  ä¹‹å‰è€ƒè™‘æœ‰é”™ğŸ˜­ï¼Œä¾‹å­å¤ªç‰‡é¢ï¼Œä¸‹æ„è¯†è®¤ä¸ºæ˜¯â€œå­ç»çˆ¶ç›¸â€ï¼Œä»¥å€æ•°è·å–è‡ªç”Ÿä½ç½®ï¼Œå®é™…é”™è¯¯å¾ˆå¤§ï¼ï¼ï¼ï¼ï¼ï¼ã€‚

çœ‹ä»¥ä¸‹ä¾‹å­ï¼š

![image-20210326163648827](ç¬”è®°.assets/image-20210326163648827.png)

ç°åœ¨æ‰è®¤è¯†åˆ°ç›¸å¯¹å®šä½çš„é—®é¢˜ã€‚



ç°åœ¨å¼€å§‹é‡æ–°åˆ†æï¼š

1. é¦–å…ˆå¾—è®¤è¯†åˆ°ï¼ŒdivåŒ…å«å››ä¸ªå­divå’ŒåŒ…å«ä¸‰ä¸ªå­divæ˜¯ç›¸åŒçš„ï¼ŒåŒºåˆ«ä»…æ˜¯å®ƒå­˜åœ¨`margin-right`å’Œ`opacity`çš„åŒºåˆ«ï¼ˆä¸ªäººè§‰å¾—ç­‰åŒäºï¼šdisplay: none;ï¼‰ï¼Œåªä¸è¿‡å¾—==æ³¨æ„==è¿™ä¸ªé€æ˜å…ƒç´ çš„ä½ç½®ï¼Œæœ¬é¢˜ä¸­ä¸€ç›´éƒ½æ˜¯å¤„äºdivçš„ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ä¼šå½±å“åˆ°==ä¹‹åä¸‰ä¸ªdivä¸ªé¡ºåºæ’åˆ—==ã€‚

   ![image-20210326165619073](ç¬”è®°.assets/image-20210326165619073.png)

   

2. è¿˜å‘ç°æœ‰çš„divï¼Œæœ‰position: relativeï¼Œæœ‰çš„divæ²¡æœ‰ã€‚

   è¿™æ˜¯éƒ½æœ‰çš„ï¼š

   ![image-20210326170837752](ç¬”è®°.assets/image-20210326170837752.png)

   è¿™æ˜¯å­˜åœ¨æ²¡æœ‰çš„ï¼š

   ![image-20210326171431289](ç¬”è®°.assets/image-20210326171431289.png)

   ç°åœ¨å¯ä»¥çœ‹å‡ºï¼šdiv.col-md-1çš„å­©å­divçš„é¡ºåºå°±æ˜¯åŸå§‹é¡ºåºï¼Œè¿™ä¸ªé¡ºåºåŠ ä¸Šposition: relative; left: xem ä¹‹åï¼Œå°±å˜ä¸ºäº†æ–°é¡ºåºï¼Œå½“ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸å­˜åœ¨position: relative æ ·å¼çš„å°±ä¿ç•™åŸä½ç½®ã€‚



3. å­©å­ä¸º4ä¸ªdivçš„åŒç†ï¼Œç¬¬ä¸€ä¸ªdivå› ä¸ºæ˜¯éšå½¢çš„ï¼Œå½“ä½œæ²¡çœ‹è§å³å¯ï¼ŒåŒæ ·ä¹Ÿå½“3ä¸ªdivå¤„ç†ï¼Œ==ä½†æ˜¯==ï¼Œåœ¨éšå½¢å…ƒç´ ä¹‹åä½ç½®çš„å…ƒç´ å¾—ä½ç½®å¾—æå‰ä¸€ä¸ªã€‚ï¼ˆå¦‚æœå®ƒä¹‹å‰æœ‰2ä¸ªéšå½¢å…ƒç´ ï¼Œé‚£ä¹ˆå®ƒçš„indexä¹Ÿå¾—æå‰2ï¼Œè¿™æ‰æ˜¯æœ€åˆæ’é™¤éšå½¢å…ƒç´ ä¹‹åï¼Œè¯¥å…ƒç´ åº”è¯¥åœ¨çš„ä½ç½®ï¼‰ã€‚

4. ä¼ªå…ƒç´ é€‰æ‹©å™¨æƒ…å†µï¼š

![image-20210326172033745](ç¬”è®°.assets/image-20210326172033745.png)





==è¡¥å……==ï¼šè¿‡ç¨‹ä¸­æŠ¥é”™ï¼Œä¹‹åè¿˜å‘ç°äº†å€¼div.col-md-1çš„å­©å­å­˜åœ¨2ä¸ªçš„æƒ…å†µï¼Œéƒ½æ˜¯æœ‰æ•ˆæ•°å­—ï¼Œè¯·æ³¨æ„ã€‚

![image-20210326180031109](ç¬”è®°.assets/image-20210326180031109.png)

> ä¿®æ­£ä»£ç 

```python
"""
cssåçˆ¬-1
"""
from env import Env
import re
from lxml import etree

env = Env()
env.login()
session = env.session

"""
åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦ä¸ºé€æ˜å…ƒç´ 
    clazz: è¯¥divçš„class
    style: é¡µé¢æ€»styleå±‚å æ ·å¼è¡¨
"""
def is_opacity(clazz, style):
    opacity = re.search(clazz + ' \\{ opacity:0 \\}', style)
    return opacity is not None


"""
è§£æ div.col-md-1 è¿™ä¸ªdiv, è¿”å›çœŸå®æ•°æ®(çš„å­—ç¬¦ä¸²å½¢å¼)
"""
def parse_div(div, style, test_text):
    children = div.xpath('./div')
    # ä¼ªå…ƒç´ é€‰æ‹©å™¨æƒ…å†µ: å› ä¸ºé¡µé¢æ¯ä¸ªdivä¸­éƒ½æ˜¯è¦ä¹ˆåŒ…å«ä¸€ä¸ªæ•°å­—ã€è¦ä¹ˆä¸ºç©ºå€¼, æ‰€ä»¥xpath('text()')å¾—åˆ°çš„ç»“æœçš„åˆ—è¡¨é•¿åº¦æ— éå°±æ˜¯ 0æˆ–1, 0è¡¨ç¤ºæ²¡æœ‰å†…å®¹
    for index, child in enumerate(children):
        # é•¿åº¦ä¸º0 è¯´æ˜è¿™ä¸ªdivå°±æ˜¯ <div>::before</div>
        if len(child.xpath('./text()')) == 0:
            # ä»styleæ ·å¼è¡¨ä¸­å°† child è¿™ä¸ªdivçš„classå€¼å¯¹åº”çš„ content ç»™å–å‡ºæ¥  å¦‚: UFihK6LyIh:before { content:"240" } å°†240æ‰¾å‡º
            return re.search(child.attrib['class'] + ':before \\{ content:"(\\d+)" \\}', style).group(1)

    # æ¥ä¸‹æ¥æ˜¯å­©å­æœ‰3/4ä¸ªçš„å¤„ç† æ³¨æ„: åœ¨éšå½¢å…ƒç´ ä¹‹åå‡ºç°çš„divå…ƒç´ å®ƒçš„indexéƒ½å¾—å‡å»å®ƒä¹‹å‰éšå½¢å…ƒç´ å‡ºç°çš„ä¸ªæ•°, æ‰æ˜¯è¯¥divçš„åˆå§‹ä½ç½®
    opacity_count = 0
    # resè£…æœ€ç»ˆç»“æœ æœ€å¤šä¹‹æ”¯æŒ4ä½æ•°å­—
    res = [-1, -1, -1, -1]
    # indexèƒ½è®°å½•å½“å‰divåœ¨æºç ä¸­çš„ç´¢å¼•
    for index, child in enumerate(children):
        # ç±»å
        clazz = child.attrib['class']

        # åˆ¤æ–­å½“å‰å…ƒç´ æ˜¯å¦ä¸ºé€æ˜å…ƒç´ 
        if is_opacity(clazz, style):
            opacity_count += 1
            continue

        # éé€æ˜å…ƒç´ , å…ˆçœ‹æ˜¯å¦æœ‰position: relative
        relative = re.search(clazz + ' \\{ position:relative \\}', style)

        # å½“å‰divçš„å€¼
        val = child.xpath('./text()')[0]
        # ä¸å­˜åœ¨çš„è¯å®šä½, å°±æ˜¯åŸä½ç½®, ä½†æ˜¯å¾—åˆ¨å»éšè—å…ƒç´ ç«™çš„ä½ç½®
        if relative is None:
            res[index - opacity_count] = val
        else:
            # å­˜åœ¨å®šä½å°±ä½¿ç”¨å½“å‰indexåŠ ä¸Šleft:xem çš„å€¼, å…ˆè·å–left:xem  æ³¨æ„search (:?)
            offset = re.search(clazz + ' \\{ left:(-?\\d)em \\}', style).group(1)
            res[index + int(offset) - opacity_count] = val

    # try:
    r = ''.join([i for i in res if i != -1])
    # except Exception as e:
    #     print(e)
    return r


"""
è·å–æ¯ä¸€é¡µæ•°å­—å’Œ
"""
def get_page_sum(page_num):
    url = f"http://www.glidedsky.com/level/web/crawler-css-puzzle-1?page={page_num}"
    response = session.get(url, headers=env.headers)
    html = etree.HTML(response.text)

    div_list = html.xpath('//div[@class="card-body"]//div[@class="col-md-1"]')
    # æµè§ˆå™¨ä¸­ç”Ÿæˆçš„æ ·å¼
    style = html.xpath('normalize-space(//style/text())')
    # æ¯é¡µå’Œ
    page_total = 0
    for div in div_list:
        # è§£ædiv
        page_total += int(parse_div(div, style, response.text))
    return page_total


# æ€»å’Œ
total = 0
# å®šä¹‰å’Œ
for page_num in range(1, 1001):
    total += get_page_sum(page_num)
    print(f'å‰ {page_num} é¡µå’Œä¸º {total}')

```



# 8.é›ªç¢§å›¾åçˆ¬-1

é¡µé¢ç»“æ„å…¨æ˜¯ `div.col-md-1` ä¸­åŒ…å«2/3ä¸ªdivï¼Œclasséƒ½æ˜¯éšæœºä¸² + ' sprite'ï¼Œ è€Œ'sprite'è¿™ä¸ªæ ·å¼çš„`background-image: url()`åŒ…å«base64ä¸²ã€‚

å¤šåˆ·æ–°å‡ æ¬¡ç½‘é¡µå¯ä»¥å‘ç°æ¯æ¬¡é›ªç¢§å›¾ä¸­æ¯ä¸ªæ•°å­—å¤§å°æœ‰å·®å¼‚ï¼Œé‚£ä¹ˆå®ƒ==background-position-x==çš„å€¼å°±æœ‰ä¸€å®šå·®å¼‚ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°åŒä¸€ä¸ªæ•°å­—åç§»çš„'x'å€¼ç›¸åŒï¼Œå¹¶ä¸”å› ä¸ºåŸå›¾ç‰‡ä¸­æ•°å­—éƒ½æ˜¯ä»å·¦åˆ°å³ä»å°åˆ°å¤§æ’åˆ—çš„ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å½“å‰é¡µæ‰€æœ‰æºå¸¦'sprite'æ ·å¼çš„divï¼Œæ¯ä¸€ä¸ªdivéƒ½æœ‰ä¸€ä¸ªéšæœºçš„classï¼Œå¦‚ 'qaz' å®ƒçš„position-xä¸º-12ï¼Œ'wsx'å®ƒçš„position-xä¸º-23ï¼Œ'edc'çš„postion-xä¸º0ã€‚

```json
{
    "qaz": -12,
    "wsx": -23,
    "edc": 0
}
â†“
[ ("qaz", -12), ("wsx", -23), ("edc", 0) ]

d_order = sorted(å­—å…¸.items(),key=lambda x:x[1],reverse=True)
æˆ–è€…
åˆ—è¡¨.sort(key=lambda x:x[1], reverse=True)  # è¿™ä¸ªåˆ—è¡¨æ˜¯ä¸Šé¢ â†“ çš„é‚£ä¸ª
```

å°†å€¼è¿›è¡Œé¡ºåºæ’åˆ—ï¼Œå¾—åˆ°

```json
[ "edc", "qaz", "wsx" ]
æˆ–è€…
[ ("edc", 0), ("qaz", -12), ("wsx", -23) ]
```

é‚£ä¹ˆæ¥ä¸‹æ¥å†é¡ºåºè§£ææ¯ä¸ªdivæ—¶ï¼Œå°±èƒ½æ ¹æ®å®ƒçš„**class**æ‹¿åˆ°å¯¹åº”çš„**æ•°å­—**äº†ã€‚



> é¡ºåºæ’åˆ—å–ç´¢å¼•ä¸ºæ•°å­—çš„æ€ç»´å‡ºäº†ç‚¹é—®é¢˜ï¼Œå› ä¸ºä¹‹å‰åªæ³¨æ„åˆ°äº†ç›¸åŒæ•°å­—çš„ postion-x æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯æ²¡æ³¨æ„åˆ°å°½ç®¡ position-x æƒ³é€šäº†ï¼Œä½†æ˜¯å®ƒä»¬çš„ class ä¾æ—§ä¸æ˜¯åŒä¸€ä¸ªï¼ï¼ï¼

![image-20210327171830776](ç¬”è®°.assets/image-20210327171830776.png)



é‡æ–°è€ƒè™‘å¦‚ä¸‹ç»“æ„ï¼ˆ==qaz==å’Œ==rfv==è‚¯å®šéƒ½ä»£è¡¨ä¸€ä¸ªæ•°å­—ï¼Œåªæ˜¯classä¸åŒï¼‰ï¼š

```json
{
    "qaz": -12,
    "wsx": -23,
    "edc": 0,
    "rfv", -12
}
```

æˆ‘ä»¬ç›´æ¥æ„å»ºä¸Šè¿°å­—å…¸å³å¯ã€‚

è¿™ç§æœç´¢position-xé€†åºæ’åˆ—ï¼Œæœ‰ä¸ªå·¨å¤§æ¼ï¼š

![image-20210327201532691](ç¬”è®°.assets/image-20210327201532691.png)



> é”™è¯¯ä»£ç 

```python
"""
çˆ¬è™«-é›ªç¢§å›¾-1
"""
from env import Env
from lxml import etree
import re

# è°ƒç”¨å°è£…çš„ç™»é™†ç¯å¢ƒ
env = Env()
session = env.login()

"""
æºç ä¸­é€šè¿‡è§£æstyle, è¿”å›
è¿”å›å€¼1: { "qaz": "-12", "wsx": "0", "rfv": "-12", ...}
è¿”å›å€¼2: [ "0", "-12" ]
"""
def get_clazzs_num_dict(style):
    # resç»“æ„å¦‚ä¸‹: [('fDn6AFGqT', '-23'), ('brq23DUc', '-36'), ...]
    class_num_dict = re.findall('.([0-9a-zA-Z]+) { background-position-x:(-?\\d+)px }', style)
    class_num_dict = dict(class_num_dict)

    # å¯¹numé€†åºæ’åº
    # å…ˆå»é‡
    offset_list = list(set(class_num_dict.values()))
    # å†æ ¹æ®offsetæ•°å€¼è¿›è¡Œæ’åº
    offset_list.sort(key=lambda item: int(item), reverse=True)

    print(class_num_dict)
    print(offset_list)

    return class_num_dict, offset_list


"""
è·å–æ¯ä¸€é¡µæ•°å­—å’Œ
"""
def get_page_sum(page_num):
    url = f"http://www.glidedsky.com/level/web/crawler-sprite-image-1?page={page_num}"
    response = session.get(url, headers=env.headers)
    # è·å–æ¯ä¸€ä¸ªæ•°å­—æ¡†
    html = etree.HTML(response.text)
    div_list = html.xpath('//div[@class="card-body"]//div[@class="col-md-1"]')

    print('-'*100)
    print(response.text)
    print('-'*100)

    # cssæ ·å¼è¡¨å­—ç¬¦ä¸²
    style = html.xpath('normalize-space(//style/text())')
    # å¾—åˆ° class -> num çš„å­—å…¸
    clazz_num_dict, offset_list = get_clazzs_num_dict(style)
    # æ¯é¡µå’Œ
    page_total = 0
    for div_col in div_list:
        # ä¸€ä¸ªdiv.col-md-1å†…æœ‰lengthä¸ªå­div(å³æ•°å­—æ˜¯lengthä½æ•°)
        length = len(div_col)
        one = 0
        for i in range(0, length):
            # å¦‚class="Fp0PceYg sprite" åº”è¯¥åªè¦Fp0PceYg
            clazz = div_col[i].attrib['class']
            clazz = clazz[:clazz.index(' ')]
            # clazz_num_dict ä¸­, é”®ä¸ºclass, å€¼ä¸ºoffset
            offset = clazz_num_dict[clazz]
            # ç™¾ä½ä¹˜100 åä½ä¹˜10 ä¸ªä½ä¹˜1
            one += offset_list.index(offset) * pow(10, length-i-1)

        # åŠ è¿™ä¸€ä¸ªæ•°
        print(one)
        page_total += one

    return page_total


# æ€»å’Œ
total = 0
# å®šä¹‰å’Œ
# for page_num in range(1, 1001):
for page_num in range(1, 2):
    total += get_page_sum(page_num)
    print(f'å‰ {page_num} é¡µå’Œä¸º {total}')
```





> æ‰€ä»¥è¯´æ˜ï¼šä¹‹å‰çš„æ€è·¯å…¨éƒ¨æœ‰é—®é¢˜ï¼Œå‚è€ƒç½‘ä¸Šè§£æ³•åï¼Œå‘ç°è¿˜æ˜¯å¾—å‡åŒ€åˆ‡å‰²å›¾ç‰‡åˆ’åˆ†æ¨ªå‘10ä¸ªåæ ‡èŒƒå›´ï¼Œåˆ†åˆ«è¡¨ç¤º[0 ,9]ï¼Œ
>
> è¿™é‡Œèƒ½å–å·§å°±æ˜¯å°† `|position-x| * 10 / æ•´ä¸ªå›¾ç‰‡æ¨ªå‘å®½åº¦` å–æ•´å³ä¸ºæ•°å­—,æ³¨æ„å–æœ€æ¥è¿‘çš„æ•´æ•°(å¦‚3.2å–3, 3.8å–4)

è¿™ä¸ªç®—å¼ä¾æ—§å­˜åœ¨é—®é¢˜,å› ä¸ºä¸åŒçš„å•ä½æ•°å­—è¿˜å­˜åœ¨ä¸€ä¸ªä¸åŒçš„å®½åº¦ï¼ï¼ï¼ï¼











ä»¥ä¸Šè¿™ä¸ªæ–¹æ³•æ˜¯é»˜è®¤å›¾ç‰‡ä¸­ä¸€ä¸²æ•°å­—åˆ’åˆ†æ¯”è¾ƒæ•´é½é‡‡ç”¨çš„ä¼°ç®—å½¢å¼ï¼Œå®é™…å¹¶ä¸å‡†ç¡®ã€‚

> ä¸‹é¢å‚è€ƒå¤§ä½¬ï¼ˆgithubæœç´¢==glidedsky_turboway==ï¼‰çš„åƒç´ æ³•ï¼Œç«–çº¿æ‰«æåˆ¤æ–­é»‘ç™½ï¼Œä»¥æ­¤åˆ’åˆ†å‡ºæ¯ä¸ªæ•°å­—åæ ‡èŒƒå›´ã€‚

ä¸ªäººåˆ†æï¼š

![image-20210328101500198](ç¬”è®°.assets/image-20210328101500198.png)

å°†æ–­ç‚¹å½¢æˆåˆ—è¡¨ï¼ˆé•¿åº¦ä¸º11ï¼ŒåŒ…æ‹¬å¼€å§‹ã€ç»“å°¾ï¼‰ï¼Œé‚£ä¹ˆæ¯é¡ºåº2ä¸ªåˆ—è¡¨å…ƒç´ å°±èƒ½å½¢æˆ10ä¸ªåŒºé—´ï¼Œé‚£ä¹ˆçœŸå®çš„æ•°å­—å°±å’Œè¿™ä¸ªåˆ—è¡¨çš„ç´¢å¼•äº§ç”Ÿè”ç³»äº†ã€‚

é‡ç‚¹åœ¨äºå¦‚ä½•æ‰«æåˆ†å‰²ï¼šéå†æ¨ªåæ ‡ï¼Œå¾ªç¯å†…éå†çºµåæ ‡ï¼Œéå†çºµåæ ‡è¿‡ç¨‹å‡ºç°é»‘ç‚¹å³è¡¨ç¤ºå½“å‰çš„æ¨ªåæ ‡å°±æ˜¯`æ•°å­—çš„å¼€å§‹`ï¼ˆé™¤0ä»¥å¤–ï¼Œå› ä¸º 0 æ€»æ˜¯ä» position-x: 0px å¼€å§‹çš„ï¼‰ã€‚

![image-20210328102047029](ç¬”è®°.assets/image-20210328102047029.png)

å¦‚æ­¤èƒ½å¾—åˆ°10ä¸ªposition-xçš„å€¼ï¼Œåˆ—è¡¨è¿½åŠ ä¸€ä¸ªå›¾ç‰‡å®½åº¦å³ä¸ºç»“æœï¼Œå°±åˆæˆä¸ºæ€»çš„åŒ…å«10ä¸ªåŒºé—´çš„åˆ¤å®šåˆ—è¡¨ã€‚



ä¹‹å‰çš„åˆ’åˆ†æ–¹å¼æœ‰é”™ï¼Œåº”è¯¥åœ¨0ç»“æŸçš„æ—¶å€™å°±å¼€å§‹åˆ†éš”ï¼Œå› ä¸ºæ­¤æ—¶0å·²ç»ä¸ä¼šå†å‡ºç°äº†ã€‚

ç»“åˆé¡µé¢åˆ†æï¼š0åç§»ä¸º ==-7== æ—¶ï¼Œ

![image-20210328122202793](ç¬”è®°.assets/image-20210328122202793.png)

0åç§»ä¸º ==-8==æ—¶ï¼Œå°±å·²ç»æ¶ˆå¤±ï¼Œ0éƒ½å·²ç»æ¶ˆå¤±äº†ï¼Œä¹Ÿå°±ä¸å¯èƒ½ç®—åœ¨0çš„èŒƒå›´å†…äº†ã€‚

![image-20210328122300778](ç¬”è®°.assets/image-20210328122300778.png)



æ‰€ä»¥åº”å½“æŒ‰ä¸‹é¢è¿™ç§æ–¹æ³•åˆ’åˆ†ã€‚

![image-20210328115647674](ç¬”è®°.assets/image-20210328115647674.png)

```python
"""
çˆ¬è™«-é›ªç¢§å›¾-1
"""
from env import Env
from lxml import etree
import re
from PIL import Image
import base64
import io

# è°ƒç”¨å°è£…çš„ç™»é™†ç¯å¢ƒ
env = Env()
session = env.login()


"""
ç”Ÿæˆåˆ†éš”åˆ—è¡¨
    å¦‚: [-1, 8, 19, 31, 43, 54, 66, 79, 93, 104, 117]
"""
def get_split_list(style):
    split = []
    # è·å–å›¾ç‰‡çš„å°ºå¯¸
    base64_bytes = base64.b64decode(re.search('base64,(.*?)\"', style).group(1))
    fio = io.BytesIO(base64_bytes)
    img = Image.open(fio)
    # è·å–åƒç´ é›†
    pixels = img.load()
    # å‰ä¸€åˆ—ä¸Š å…¨ç™½
    last_x_all_white = True
    # x è¡¨ç¤ºä»å·¦åˆ°å³
    for x in range(img.width):
        # å½“å‰åˆ—å…¨ä¸ºç™½è‰²
        current_x_all_white = True
        # y è¡¨ç¤ºä»ä¸Šåˆ°ä¸‹
        for y in range(img.height):
            # print(f'{x,y}: ', pixels[x, y])
            # rgbå’Œç­‰äº255*3, åˆ™ä¸ºç™½è‰², ä¸ç­‰åˆ™ä¸ä¸ºç™½è‰²
            if sum(pixels[x, y][:3]) != 255 * 3:
                # å½“å‰åˆ—å­˜åœ¨ éç™½è‰²
                current_x_all_white = False
                break

        # ä¸€åˆ—ç»“æŸ è‹¥current_x_all_whiteè¿˜ä¸ºTrue é‚£ä¹ˆè¯´æ˜å½“å‰åˆ—å…¨ä¸ºç™½è‰²
        if current_x_all_white:
            # å½“å‰åˆ—å…¨ç™½è‰², å¹¶ä¸”ä¸Šä¸€åˆ—å­˜åœ¨é»‘
            if not last_x_all_white:
                split.append(x)

        # è¿›è¡Œä¸‹ä¸€åˆ—ä¹‹å‰ last_x_all_whiteå°±å¾—æ ¹æ®å½“å‰åˆ—é‡æ–°èµ‹å€¼
        last_x_all_white = current_x_all_white

    # å¼€å¤´æ’å…¥-1 å› ä¸ºåªè®°å½•äº†0çš„ç»“æŸ æ²¡æœ‰è®°å½•å¼€å§‹
    split.insert(0, -1)
    # èµ‹å€¼æœ€åä¸€ä¸ªä¸ºå›¾ç‰‡å®½åº¦
    split[len(split) - 1] = img.width

    return split


"""
æºç ä¸­é€šè¿‡è§£æstyle, æ„å»º class -> offset 
è¿”å›å€¼ç»“æ„: { "qaz": '-12', "wsx": '0', "rfv": '-12', ...}
"""
def get_clazzs_num_dict(style):
    # findallç»“æ„å¦‚ä¸‹: [('qaz', '-12'), ('wsx', '0'), ('rfv': '-12') ...]
    # ä½¿ç”¨dictæ„å»ºå¦‚ä¸‹å­—å…¸ { "qaz": "-12", "wsx": "0", "rfv": "-12", ...}
    class_num_dict = dict(re.findall('.([0-9a-zA-Z]+) { background-position-x:(-?\\d+)px }', style))
    # å°†å€¼è½¬ä¸ºint å¹¶å–ç»å¯¹å€¼
    for _ in class_num_dict:
        class_num_dict[_] = abs(int(class_num_dict[_]))
    return class_num_dict


"""
è·å–æ¯ä¸€é¡µæ•°å­—å’Œ
"""
def get_page_sum(page_num):
    url = f"http://www.glidedsky.com/level/web/crawler-sprite-image-1?page={page_num}"
    response = session.get(url, headers=env.headers)
    # è·å–æ¯ä¸€ä¸ªæ•°å­—æ¡†
    html = etree.HTML(response.text)
    div_list = html.xpath('//div[@class="card-body"]//div[@class="col-md-1"]')

    # cssæ ·å¼è¡¨å­—ç¬¦ä¸²
    style = html.xpath('normalize-space(//style/text())')
    # å¾—åˆ° class -> offset çš„å­—å…¸
    class_num_dict = get_clazzs_num_dict(style)
    # å¾—åˆ°åˆ†éš”åˆ—è¡¨
    split_list = get_split_list(style)
    # æ¯é¡µå’Œ
    page_total = 0
    for div_col in div_list:
        # ä¸€ä¸ªæ•°åŒ…å«å¤šå°‘ä½
        length = len(div_col)
        num = 0
        for _ in range(0, length):
            # å¦‚class="Fp0PceYg sprite" åº”è¯¥åªè¦Fp0PceYg
            clazz = div_col[_].attrib['class']
            clazz = clazz[:clazz.index(' ')]
            # clazz_num_dict ä¸­, é”®ä¸ºclass, å€¼ä¸ºåç§»
            offset = class_num_dict[clazz]
            # è·å¾—çœŸå®æ•°å­—n
            for index, split in enumerate(split_list):
                # å½“offsetä¸º0 splitä¸º-1 è¿™æ‰èƒ½åˆ¤æ–­æˆåŠŸ
                if offset < split:
                    n = index - 1
                    break
            num += n * pow(10, length - _ - 1)

        # åŠ è¿™ä¸€ä¸ªæ•°, æ¯é¡µæœ‰12ä¸ªæ•°å˜›
        page_total += num

    return page_total


# æ€»å’Œ
total = 0
# å®šä¹‰å’Œ
for page_num in range(1, 1001):
    total += get_page_sum(page_num)
    print(f'å‰ {page_num} é¡µå’Œä¸º: {total}')
```



# 9.çˆ¬è™«-éªŒè¯ç -1

åˆ†æï¼š

![image-20210329104246960](ç¬”è®°.assets/image-20210329104246960.png)



![image-20210329112945332](ç¬”è®°.assets/image-20210329112945332.png)



æ»‘åŠ¨æŒ‰é’®åº”è¯¥å³ç§»çš„è·ç¦»å¾—åˆ°äº†ï¼Œç›´æ¥æ“ä½œæ»‘åŠ¨æŒ‰é’®å³ç§»ï¼Œå³å¯å®Œæˆè¯¥æ»‘åŠ¨éªŒè¯ã€‚

éœ€è¦æ³¨æ„ï¼ŒéªŒè¯æ¡†æ˜¯`iframe`æ ‡ç­¾ï¼Œéœ€è¦ ==driver.switch_to.frame(frame_element)==æ“ä½œã€‚

```python
driver.switch_to.frame(iframe_element) # è½¬å‘åˆ°è¯¥frameä¸­

"""æ“ä½œframeå¤–è¾¹çš„å…ƒç´ éœ€è¦åˆ‡æ¢å‡ºå»"""
windows = driver.window_handles
driver.switch_to.window(windows[0])
```





æ³¨æ„å›¾ç‰‡è¿˜åšäº†å¹²æ‰°å¤„ç†ï¼šå®¹æ˜“çœ‹å‡ºçš„æœ‰å››è§’ã€ä¸Šæ–¹

![image-20210329150724555](ç¬”è®°.assets/image-20210329150724555.png)

![image-20210329150818451](ç¬”è®°.assets/image-20210329150818451.png)



ç„¶åå°±å¾—ç»™ä¸ªé˜ˆå€¼ï¼Œçœ‹ä¸€åˆ—æœ‰å¤šå°‘ä¸ªä¸åŒçš„åƒç´ ç‚¹ä»¥ä¸Šï¼Œæ‰ç®—åˆ°äº†å‡¹é™·å—ã€‚

ç»è¿‡æµ‹è¯•ï¼š

```
ç¬¬ 0 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 39
ç¬¬ 1 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 40
ç¬¬ 2 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 39
ç¬¬ 3 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 40
ç¬¬ 4 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 39
ç¬¬ 5 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 39
ç¬¬ 6 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 36
ç¬¬ 7 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 26
ç¬¬ 8 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 25
ç¬¬ 9 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 37
.
.
.
ç¬¬ 204 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 23
ç¬¬ 205 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 22
ç¬¬ 206 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 23
ç¬¬ 207 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 51
ç¬¬ 208 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 49
ç¬¬ 209 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 39
ç¬¬ 210 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 41
ç¬¬ 211 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 40
ç¬¬ 212 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 40
ç¬¬ 213 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 38
ç¬¬ 214 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 39

.
.
.
ç¬¬ 399 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 81
ç¬¬ 400 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 61
ç¬¬ 401 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 16
ç¬¬ 402 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 17
ç¬¬ 403 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 16
ç¬¬ 404 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 17
ç¬¬ 405 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 16
ç¬¬ 406 åˆ—åƒç´ ç‚¹å·®å¼‚ä¸º 17

```

è¯´æ˜æ•´ä¸ªå›¾ç‰‡éƒ½æ˜¯åšäº†æ··æ·†å¤„ç†çš„ï¼ï¼ï¼





![image-20210329153454753](ç¬”è®°.assets/image-20210329153454753.png)

åˆ¤æ–­ç¼ºå£çš„ç­–ç•¥ï¼š

æœ€å¼€å§‹æ˜¯æ‰“ç®—åˆ°äº†æŸä¸€åˆ—ï¼Œåƒç´ å·®å¼‚ä¸ªæ•°å‰§å¢ï¼Œå¹¶ä¸”åœ¨æ¥ä¸‹æ¥10åˆ—ä¸­ä¿æŒåƒç´ å·®å¼‚ç‚¹è¶…è¿‡100ï¼Œé‚£ä¹ˆåˆ¤æ–­è¿™ä¸ªå‰§å¢åˆ—å°±æ˜¯å‡¹é™·å›¾çš„å¼€å§‹ã€‚



> ä½†æ˜¯åæ¥å‘ç°ï¼Œä¸å¤§è¡Œï¼ï¼å›¾ç‰‡çš„æ··æ·†åšçš„å¤ªå¥½äº†......

åæ¥é‡‡ç”¨åœ¨rgbä¸‰ä¸ªæ•°ç¦»ï¼ˆ255ï¼Œ255ï¼Œ255ï¼‰ç›¸å·®éƒ½ä»…å°äº10ï¼Œå¹¶ä¸”ä¸€åˆ—ä¸­æœ‰40ï¼ˆå› ä¸ºæœ‰æ—¶å‡¹é™·å›¾å·¦ä¸­éƒ¨æœ‰ç¼ºå£ï¼Œæ²¡ç¼ºå£çš„è¯è¾¾åˆ°50ä¸ªåº”è¯¥æ²¡é—®é¢˜ï¼‰ä¸ªè¿™æ ·çš„åƒç´ ç‚¹ä»¥ä¸Šï¼Œåˆ¤æ–­è¿™åˆ—ä¸ºå‡¹é™·å›¾çš„å¼€å§‹ã€‚

![image-20210330103058466](ç¬”è®°.assets/image-20210330103058466.png)

> åæ¥ç­–ç•¥åˆæ¢æˆäº†
>
> åæ¥é‡‡ç”¨åœ¨rgbä¸‰ä¸ªæ•°ç¦»ï¼ˆ255ï¼Œ255ï¼Œ255ï¼‰ç›¸å·®éƒ½å¤§äº50æ—¶ï¼Œè®¤å®šè¿™å°±æ˜¯å‡¹é™·å—å¼€å§‹å¾—ä½ç½®ï¼ï¼ï¼





ç¡®å®šseleniumè·å–çš„webelementå¯¹è±¡çš„åæ ‡å±æ€§æ—¶ï¼Œå‘ç°æ€ä¹ˆéƒ½å¯¹ä¸ä¸Šå·ï¼Œæ‰€ä»¥æ‰æœ‰æ¥ä¸‹æ¥çš„æµ‹è¯•seleniumçš„locationï¼ˆxå’Œyå€¼ï¼‰ï¼š

è°ƒè¯•ï¼š

![image-20210329193003657](ç¬”è®°.assets/image-20210329193003657.png)

formåæ ‡ä¸ºï¼ˆ298ï¼Œ212ï¼‰ï¼Œä½†æ˜¯åœ¨æ²¡è°ƒæ•´ä¸‹é¢è¿™ä¸ªè®¾ç½®ä¹‹å‰æ€»æ˜¯å¯¹ä¸ä¸Šå·ï¼ï¼ï¼

æ³¨æ„çœ¼è§‚æµè§ˆå™¨å¤šå®½çš„æ—¶å€™ï¼Œä¸€å®šè¦æŠŠwin10æ˜¾ç¤ºè®¾ç½®ä¸º100%

![image-20210329192623923](ç¬”è®°.assets/image-20210329192623923.png)

è°ƒæ•´ä¹‹åï¼Œèƒ½å¯¹ä¸Šå·äº†ã€‚

![image-20210329192804699](ç¬”è®°.assets/image-20210329192804699.png)





æ¥ä¸‹æ¥ç¡®ä¿ä»£ç ä¸­æµ‹é‡çš„è·ç¦»éƒ½æ˜¯å¯¹çš„ï¼Œåœ¨ä»¥ä¸Šæ˜¾ç¤ºè®¾ç½®è®¾ç½®ä¸º100%ï¼ï¼ï¼ä¹‹åè¿›è¡Œæµ‹é‡ã€‚

æ»‘å—ä½ç½®ï¼šxåç§»æ˜¯36

![image-20210329193411115](ç¬”è®°.assets/image-20210329193411115.png)

ä¸‹é¢æ˜¯iframeçš„èŒƒå›´ï¼šï¼ˆå›¾ä¸­ç™½è‰²æ¡†æ˜¯æˆ‘ç”¨snipasteæˆªå‡ºçš„ `36*89` çš„çŸ©å½¢ï¼‰

![image-20210329193751170](ç¬”è®°.assets/image-20210329193751170.png)

ä¸‹é¢æ˜¯å›¾ç‰‡çš„èŒƒå›´ï¼š

![image-20210329193811188](ç¬”è®°.assets/image-20210329193811188.png)



ç”±æ­¤ï¼Œæˆ‘ä»¬å¾—å‡ºï¼Œåœ¨è¿™é‡Œå¾—å‡ºçš„locationï¼Œæ˜¯ç›¸å¯¹äºiframeæœ¬èº«çš„ï¼ï¼ï¼

è¿˜è®°å¾—ä¹‹å‰åˆ†æçš„è¿™ä¸ªå›¾ï¼Ÿ

![image-20210329194217410](ç¬”è®°.assets/image-20210329194217410.png)

ä½†ç”±äºå›¾ç‰‡è¿˜æœ‰ä¸ªé€æ˜å››å‘¨ï¼Œè¿™ä¸ªæ¨ç†è¦å‘ç”Ÿå˜åŒ–ã€‚

![image-20210329195025313](ç¬”è®°.assets/image-20210329195025313.png)



æ»‘å—ç›¸å¯¹å›¾ç‰‡çš„åç§»åº”è¯¥æ˜¯ï¼šx + x2 - x3

xï¼šå›¾ç‰‡ç›¸å¯¹iframeçš„x

x2ï¼šæ»‘å—å›¾ç‰‡çš„é€æ˜å››å‘¨å®½åº¦ï¼ˆå¤§æ¦‚æœ‰11.5ï¼‰

è¿™é‡Œx2å®ƒåŸå›¾æ˜¯136çš„ï¼Œç°åœ¨æµè§ˆå™¨ä¸­æ˜¯68çš„ï¼ŒåŸå›¾å››å‘¨å®½åº¦ä¸º23ï¼ŒæŒ‰æ¯”ä¾‹è®¡ç®—ï¼Œæµè§ˆå™¨ä¸­å››å‘¨å®½åº¦ä¸ºï¼š68*23-136=11.5

![image-20210329195710640](ç¬”è®°.assets/image-20210329195710640.png)

x3ï¼šå¤§çš„éªŒè¯å›¾ç‰‡ç›¸å¯¹iframeæœ‰ä¸ªpaddingï¼ˆå¤§æ¦‚æœ‰9.6ï¼‰

![image-20210329195339859](ç¬”è®°.assets/image-20210329195339859.png)



æ‰€ä»¥ï¼Œæˆ‘ä»¬æ‹¿åˆ°æ»‘å—çš„location['x']åç›´æ¥å‡2å³å¯ã€‚

ç»¿çº¿çš„è·ç¦»ï¼ˆå°±æ˜¯ç¼ºå£ç›¸å¯¹äºå¤§å›¾ç‰‡çš„xä½ç½®ï¼‰ï¼šå› ä¸ºè·å–çš„é“¾æ¥çš„å›¾ç‰‡ï¼Œåˆ†è¾¨ç‡æ˜¯å®é™…æ˜¾ç¤ºçš„2å€ï¼Œæ‰€ä»¥å¾—åˆ°ç»¿çº¿ä¹‹é—´çš„è·ç¦»è¿˜å¾—é™¤ä»¥2ã€‚



seleniumå­˜åœ¨ç‚¹é—®é¢˜ï¼Œä¸ªäººä¿®æ­£ï¼Œä¸ç„¶æ»‘åŠ¨å—ç§»åŠ¨å¾—å¾ˆæ…¢ï¼ï¼

```
C:\Users\L\AppData\Local\Programs\Python\Python37\Lib\site-packages\selenium\webdriver\common\actions
```



![image-20210330163244025](ç¬”è®°.assets/image-20210330163244025.png)





æˆåŠŸçš„æ ‡å¿—ï¼šå­˜åœ¨ `show-success` çš„classçš„divå‡ºç°ã€‚

![image-20210330193912026](ç¬”è®°.assets/image-20210330193912026.png)



> ä»£ç 

```python
"""
çˆ¬è™«-éªŒè¯ç -1
"""
from selenium import webdriver
from selenium.webdriver import ActionChains
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from PIL import Image
import requests
import io
import time
import random


class SeleniumEnv(object):

    def __init__(self):
        self.driver_path = 'D:\\driver\\89.0\\chromedriver.exe'
        self.url = 'http://www.glidedsky.com/level/web/crawler-captcha-1?page='

        self.driver = webdriver.Chrome(self.driver_path)
        # å‚æ•°10è¡¨ç¤ºæœ€é•¿ç­‰å¾…10ç§’, å‚æ•°0.5è¡¨ç¤º0.5ç§’æ£€æŸ¥ä¸€æ¬¡è§„å®šçš„æ ‡ç­¾æ˜¯å¦å­˜åœ¨
        self.wait = WebDriverWait(self.driver, 2, 0.5)

    # ç™»é™†
    def login(self):
        # ç™»é™†
        self.driver.get("http://www.glidedsky.com/login")
        # æœ€å¤§åŒ–çª—å£
        self.driver.maximize_window()
        self.driver.find_element_by_id('email').send_keys('ls1229344939@163.com')
        self.driver.find_element_by_id('password').send_keys('å¯†ç ')
        self.driver.find_element_by_class_name('btn-primary').click()
        time.sleep(1)

    # è·å–æ»‘åŠ¨æŒ‰é’®å¯¹è±¡
    def get_slide_button(self):
        time.sleep(1)
        btn = self.driver.find_element_by_id('slideBlock')
        return btn

    # è·å¾—åŸå›¾å’Œå‡¹é™·å›¾çš„urlå…ƒç»„
    def get_origin_cover_image(self):
        time.sleep(1)
        slide_bg = self.driver.find_element_by_id('slideBg')
        # æµ‹è¯•(é“¾æ¥æ€»æ˜¯ä¸ºç©º...)
        # print('slide_bg: ', slide_bg)
        cover_url = slide_bg.get_attribute('src')
        # print('property:', cover_url)
        origin_url = cover_url.replace('img_index=1', 'img_index=0')
        # print('åŸæ¥: ', origin_url)
        # print('è¦†ç›–: ', cover_url)
        return origin_url, cover_url

    # åˆ¤æ–­2ä¸ªåƒç´ ç‚¹ ä¸åŒè¿”å›True
    def point_diff(self, origin_pixel, cover_pixel, threshold):
        return abs(origin_pixel[0] - cover_pixel[0]) > threshold \
               and abs(origin_pixel[1] - cover_pixel[1]) > threshold \
               and abs(origin_pixel[2] - cover_pixel[2]) > threshold

    # å¯¹æ¯”åŸå›¾å’Œå‡¹é™·å›¾, è·å–å‡¹é™·å›¾ç›¸å¯¹ç›¸å¯¹æ•´ä¸ªå›¾ç‰‡çš„xåç§»é‡
    def get_offset_cover(self):
        # åˆ†åˆ«æ˜¯åŸå›¾å’Œå‡¹é™·å›¾çš„url
        origin_url, cover_url = self.get_origin_cover_image()
        # è¯·æ±‚
        origin_img = Image.open(io.BytesIO(requests.get(origin_url).content))
        origin_pixels = origin_img.load()
        # cover_pixels = Image.open(io.BytesIO(requests.get(cover_url).content)).load()
        cover_img = Image.open(io.BytesIO(requests.get(cover_url).content))
        cover_pixels = cover_img.load()

        width = cover_img.width
        height = cover_img.height
        # åŸå›¾æ˜¯680*390 æµè§ˆå™¨å®é™…æ˜¾ç¤ºæœ‰340*195å·¦å³ æœ€ååç§»è¦é™¤ä»¥2 (680/340)
        # é˜ˆå€¼
        threshold = 50
        # å–å·§ å› ä¸ºè§‚å¯Ÿåˆ°çš„ç»“æœä¸­ å‡¹é™·å›¾åœ¨çš„åƒç´ éƒ½å¤§äºäº†400åƒç´ 
        for x in range(350, width):
            for y in range(0, height):
                # é˜ˆå€¼è®¾ç½®ä¸º50å§...  r,g,bå€¼éƒ½ç›¸å·®50ä»¥ä¸Š
                if self.point_diff(origin_pixels[x, y], cover_pixels[x, y], threshold):
                    # print(f'åŸå›¾åƒç´ ç‚¹: {origin_pixels[x, y]}, å‡¹é™·å›¾åƒç´ ç‚¹: {cover_pixels[x, y]}')
                    return x / 2

    # è·å–æ»‘å—ç›¸å¯¹æ•´ä¸ªå›¾ç‰‡çš„xåç§»é‡
    def get_offset_slider(self):
        time.sleep(1)
        # self.wait.until(EC.presence_of_element_located((By.ID, 'slideBlock')))
        slide_block = self.driver.find_element_by_id('slideBlock')
        # å‡2 ç›¸å…³è¯´æ˜çœ‹ç¬”è®°
        slider_x = int(slide_block.location['x']) - 2
        # print(slider_x)
        return slider_x

    """
        éªŒè¯ç éªŒè¯è¿‡ç¨‹
    """
    def checkout(self, page_num):
        try:
            time.sleep(1)
            self.driver.get(self.url + str(page_num))
            # æ³¨æ„ï¼ï¼ï¼ éªŒè¯æ¨¡å—åœ¨iframeæ ‡ç­¾ä¸­
            # å“ªä¸ªæ‰¾ä¸åˆ° å°±åœ¨å“ªä¸ªå‰é¢åŠ sleep ï¼ï¹ï¼œ
            time.sleep(1)
            # self.wait.until(EC.presence_of_element_located((By.ID, 'tcaptcha_iframe')))
            iframe = self.driver.find_element_by_id('tcaptcha_iframe')
            self.driver.switch_to.frame(iframe)
            # è·å¾—æ»‘åŠ¨æŒ‰é’®
            slide_btn = self.get_slide_button()
            # è·å–æ»‘å—ç›¸å¯¹æ•´ä¸ªå›¾ç‰‡çš„xåç§»é‡
            slider_x = self.get_offset_slider()
            # è·å–å‡¹é™·å›¾ç›¸å¯¹ç›¸å¯¹æ•´ä¸ªå›¾ç‰‡çš„xåç§»é‡
            cover_x = self.get_offset_cover()
            # è®¡ç®—å¾—åˆ°æŒ‰é’®å‘å³æŒ‰åŠ¨çš„è·ç¦»
            # print(f'cover_x: {cover_x}, slider_x: {slider_x}')
            move_x = cover_x - slider_x
            # print('move_x:', move_x)
            self.move_to_gap(slide_btn, self.get_track(move_x))

            # ç”¨untilç­‰å¤ªä¹…äº†
            success = self.wait.until(EC.presence_of_element_located((By.CLASS_NAME, 'show-success')))

            # è¿”å›æ˜¯å¦æˆåŠŸæ ¡éªŒ
            return success is not None
        except Exception as e:
            print(e)
            return False

    # è®¡ç®—å½“å‰é¡µæ•°å­—å’Œ
    def get_total(self):
        # åˆ‡å‡ºiframe
        windows = self.driver.window_handles
        self.driver.switch_to.window(windows[0])
        div_list = self.driver.find_elements_by_xpath('//div[@class="card-body"]//div[@class="col-md-1"]')

        page_total = 0
        for div in div_list:
            page_total += int(div.text)

        return page_total

    """
       æ ¹æ®åç§»é‡è·å–ç§»åŠ¨è½¨è¿¹
       :param distance: åç§»é‡
       :return: ç§»åŠ¨è½¨è¿¹
    """
    def get_track(self, distance):
        # ç§»åŠ¨è½¨è¿¹
        track = []
        # å½“å‰ä½ç§»
        current = 0
        # å‡é€Ÿé˜ˆå€¼
        mid = distance * 4 / 5
        # è®¡ç®—é—´éš”
        t = 0.3
        # åˆé€Ÿåº¦
        v = 0
        while current < distance:
            if current < mid:
                # åŠ é€Ÿåº¦ä¸ºæ­£5
                a = 5
            else:
                # åŠ é€Ÿåº¦ä¸ºè´Ÿ3
                a = -3
            # å½“å‰é€Ÿåº¦v1 = v0 + at
            v = v + a * t
            # ç§»åŠ¨è·ç¦»x = v0t + 1/2 * a * t^2
            move = v * t + 1 / 2 * a * t * t
            # å½“å‰ä½ç§»
            current += move
            if current > distance:
                track.append(distance - current + move)
                break
            # åŠ å…¥è½¨è¿¹
            track.append(round(move))
            # tæ—¶é—´å, ç°åœ¨çš„é€Ÿåº¦
            v = v + a * t

        # print(f'track: {track}')
        return track

    """
        æ‹–åŠ¨æ»‘å—åˆ°ç¼ºå£å¤„
        :param slider: æ»‘å—
        :param track: è½¨è¿¹
        :return:
    """
    def move_to_gap(self, slider, track):
        ActionChains(self.driver).click_and_hold(slider).perform()

        for x in track:
            ActionChains(self.driver).move_by_offset(xoffset=x, yoffset=0).perform()

        time.sleep(random.random())
        ActionChains(self.driver).release().perform()


env = SeleniumEnv()
env.login()

total = 0
# è®¿é—®çš„é¡µæ•°
page = 967

while True:
    sign = env.checkout(page)

    # å¦‚æœéªŒè¯å¤±è´¥
    if not sign:
        fail_count = 1
        print(f'ç¬¬ {page} é¡µå¤±è´¥(1)!!!')
        # é‡å¤æ“ä½œ ç›´åˆ°è¿‡éªŒè¯
        while True:
            sign = env.checkout(page)
            if sign:
                print(f'ç¬¬ {page} é¡µæˆåŠŸ(n)!!!')
                break
            else:
                print(f'ç¬¬ {page} é¡µå¤±è´¥(n) åˆå¤±è´¥{fail_count}æ¬¡!!!')
                fail_count += 1
                if fail_count > 3:
                    # é‡å¯æµè§ˆå™¨
                    env.driver.quit()
                    env = SeleniumEnv()
                    env.login()
                    fail_count = 0

    else:
        print(f'ç¬¬ {page} é¡µæˆåŠŸ(1)!!!')
    # è·å–å½“å‰é¡µå’Œ
    # ç­‰æ•°å­—åŠ è½½å®Œæ¯•
    time.sleep(1)
    total += env.get_total()

    print(f'å‰{page}é¡µå’Œä¸º {total} ')
    page += 1
    if page == 1001:
        env.driver.quit()
        break

"""
ä¸­é—´æ€»æœ‰ç½‘ç»œåŸå› ...æœ‰æ—¶è¿é¡µé¢éƒ½æ‰“ä¸å¼€ å®åœ¨åŠ è½½ä¸å‡ºæ¥, åˆ†äº†å¤šæ¬¡æµ‹, å¤§æ¦‚æµ‹äº†10å¤šæ¬¡å§...
æˆ‘æ‰‹åŠ¨æ“ä½œéƒ½è¿˜èƒ½ä¸€ç›´å‡ºç° "ç½‘ç»œææƒšäº†ä¸€ä¸‹"/"æ‹¼å›¾å—åŠè·¯ä¸¢å¤±"  ???

[1, 272] => 948786 
æ€ä¹ˆæœåŠ¡å™¨è¿˜èƒ½ internal server error(nginx) å•Š...
[273, 378) => 368900

T^T
[378, 1000] => 2177686

3495372

æ€€ç–‘æ˜¯è…¾è®¯é˜²æ°´å¢™æœ‰ä¸€å®šçš„è®¿é—®é™åˆ¶, å»ºè®®æ¯è¿‡100é¡µç­‰ä¸ª10åˆ†é’Ÿå†çˆ¬
"""
```



æˆ‘é ï¼Œé¡µé¢åˆ·æ–°ä¸å‡ºæ¥æˆ‘èƒ½å’‹åŠå•Šï¼Ÿ

chromeï¼š

![image-20210401142245031](ç¬”è®°.assets/image-20210401142245031.png)



åˆ·æ–°å‡ºæ¥äº†ç­‰è‡ªå·±æ‰‹åŠ¨æ“ä½œä¹Ÿå‡ºç°è¿™ç§ï¼š

![image-20210401151459005](ç¬”è®°.assets/image-20210401151459005.png)

![image-20210401151742720](ç¬”è®°.assets/image-20210401151742720.png)



# 10.çˆ¬è™«-JSåŠ å¯†1

> åˆ†æ

æºç ä¸­çš„å“åº”çš†ä¸ºç©ºä¸²ï¼š

![image-20210402105509243](ç¬”è®°.assets/image-20210402105509243.png)



ç»“åˆé¡µé¢å“åº”åˆ†æï¼š

![image-20210402105557772](ç¬”è®°.assets/image-20210402105557772.png)

æ•°æ®åº”è¯¥å°±æ˜¯å¼‚æ­¥åŠ è½½çš„äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ¨¡æ‹Ÿå¼‚æ­¥GETè¯·æ±‚äº†ã€‚



urlï¼š

```
http://www.glidedsky.com/api/level/web/crawler-javascript-obfuscation-1/items?page=1&t=1617340189&sign=e7c6b4b333bd07e4753288ca683062e925703341
```

å‚æ•°åˆ†æï¼š

pageæ˜¯é¡µæ•°

tæ˜æ˜¾æ˜¯ç§’çº§æ—¶é—´æˆ³

![image-20210402105812203](ç¬”è®°.assets/image-20210402105812203.png)

signå°±æ˜¯åŠ å¯†èº«ä»½éªŒè¯ä¸²äº†ï¼Œåœ¨æºç åŠå“åº”ä¿¡æ¯ä¸­searchä¸åˆ°ï¼Œå¹¶ä¸”æ¯æ¬¡éƒ½ä¼šå˜åŒ–ï¼Œé‚£ä¹ˆæ¨æµ‹æ˜¯`æœ¬åœ°jsç”Ÿæˆ`ã€‚

è°ƒè¯•`sha1.js`æ–‡ä»¶ï¼š

![image-20210402113132178](ç¬”è®°.assets/image-20210402113132178.png)

ä¸‹ä¸€æ­¥è¿‡åï¼Œä¼šå‘ç°signçš„å€¼å°±æ˜¯è¿™ä¸ªreturnè¯­å¥è¿”å›çš„ç»“æœã€‚

å¯ä»¥æ¯”è¾ƒwatchçª—å£ä¸­çš„å€¼ï¼Œè¿™é‡Œåªåˆ—ä¸¾äº†å‰å‡ ä¸ªå€¼ï¼Œå¯ä»¥çœ‹åˆ°éƒ½æ˜¯å’Œsignç›¸ç­‰çš„ï¼Œå¯ä»¥è¯´æ˜è¿™ä¸ªå‡½æ•°å°±æ˜¯ç”Ÿæˆsignçš„å‡½æ•°ï¼Œè¿”å›å€¼æ­£å¥½æœ‰40é¡¹ï¼

```javascript
t.prototype.hex = function() {
        this.finalize();
        var t = this.h0
          , h = this.h1
          , s = this.h2
          , i = this.h3
          , e = this.h4;
        return r[t >> 28 & 15] + r[t >> 24 & 15] + r[t >> 20 & 15] + r[t >> 16 & 15] + r[t >> 12 & 15] + r[t >> 8 & 15] + r[t >> 4 & 15] + r[15 & t] + r[h >> 28 & 15] + r[h >> 24 & 15] + r[h >> 20 & 15] + r[h >> 16 & 15] + r[h >> 12 & 15] + r[h >> 8 & 15] + r[h >> 4 & 15] + r[15 & h] + r[s >> 28 & 15] + r[s >> 24 & 15] + r[s >> 20 & 15] + r[s >> 16 & 15] + r[s >> 12 & 15] + r[s >> 8 & 15] + r[s >> 4 & 15] + r[15 & s] + r[i >> 28 & 15] + r[i >> 24 & 15] + r[i >> 20 & 15] + r[i >> 16 & 15] + r[i >> 12 & 15] + r[i >> 8 & 15] + r[i >> 4 & 15] + r[15 & i] + r[e >> 28 & 15] + r[e >> 24 & 15] + r[e >> 20 & 15] + r[e >> 16 & 15] + r[e >> 12 & 15] + r[e >> 8 & 15] + r[e >> 4 & 15] + r[15 & e]
    }
```



åˆ·æ–°ï¼Œé‡æ–°è°ƒè¯•ï¼Œçœ‹ä¸‹ä¸€æ­¥æ‰§è¡Œä»€ä¹ˆï¼š

![image-20210402131212832](ç¬”è®°.assets/image-20210402131212832.png)

![image-20210402131215665](ç¬”è®°.assets/image-20210402131215665.png)

![image-20210402131400015](ç¬”è®°.assets/image-20210402131400015.png)



æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•çš„åˆ°å‚æ•°`t`å’Œå‚æ•°`sign`äº†ã€‚

```js
let p = $('main .container').attr('p');
let t = Math.floor(($('main .container').attr('t') - 99) / 99);
let sign = sha1('Xr0Z-javascript-obfuscation-1' + t);
$.get('/api/level/web/crawler-javascript-obfuscation-1/items?page=' + p + '&t=' + t + '&sign=' + sign, function (data) {
    const list = JSON.parse(data).items;
    $('.col-md-1').each(function (index) {
        if (list && index < list.length) {
            $('.col-md-1').eq(index).text(list[index])
        }
    })
})
```

tå°±æ˜¯å½“å‰çš„ç§’çº§æ—¶é—´æˆ³

```python
time.time()
```

signå¾—è°ƒç”¨sha1çš„å‡½æ•°ï¼šå‚æ•°æ˜¯=='Xr0Z-javascript-obfuscation-1' + 'æ—¶é—´æˆ³'==ï¼Œè°ƒç”¨æ–¹æ³•æ˜¯ï¼šå°†sha1.jsä¸‹è½½ä¸‹æ¥ï¼Œé‡‡ç”¨js2pyï¼Œç”¨pythonåŠ¨æ€æ‰§è¡Œjsä»£ç ã€‚

```python
"""
    jsåŠ å¯†-1
"""
from env import Env
import js2py
import math
import time
import json

env = Env()
session = env.login()

# ç”Ÿæˆjsæ‰§è¡Œç¯å¢ƒ
context = js2py.EvalJs()
# pythonè¯»å–js
with open('js-obfuscation-1-test/js/sha1.js', 'r', encoding='utf-8') as f:
    context.execute(f.read())


"""
    è·å¾—å‚æ•°tå’Œsign
"""
def get_t_and_sign():
    # éœ€è¦æå‰å®šä¹‰çš„å‚æ•°
    context.t = math.floor(time.time())
    # éœ€æ‰§è¡Œjsä»£ç 
    js = '''
        var sign = sha1('Xr0Z-javascript-obfuscation-1' + t);
    '''
    # æ‰§è¡Œjsä»£ç 
    context.execute(js)
    return context.t, context.sign


# å®šä¹‰ å’Œ
total = 0
for page_num in range(1, 1001):

    t, sign = get_t_and_sign()

    url = f'http://www.glidedsky.com/api/level/web/crawler-javascript-obfuscation-1/items?page={page_num}&t={t}&sign={sign}'

    response = session.get(url, headers=env.headers)

    # print(json.loads(response.text))
    nums = json.loads(response.text)['items']
    total += sum(nums)

    print(f"å‰ {page_num} é¡µæ•°å­—å’Œä¸º: {total}")


print(f"ç»“æœæ˜¯: {total}")
# è¿™ä¸ªè¿è¡Œç€å°±å¾ˆçˆ½äº†å– (â€¢Ï‰â€¢`)  èˆ’æœ
```





# 11.çˆ¬è™«-éªŒè¯ç -2

é¡µé¢è®¿é—®å¥½åƒæ²¡æœ‰å†…å®¹äº†ï¼šhttp://www.glidedsky.com/level/web/crawler-captcha-2

![image-20210402135120473](ç¬”è®°.assets/image-20210402135120473.png)

åªä¸è¿‡å°±ç®—åšï¼Œä¼°è®¡æˆ‘ä¹Ÿæ²¡æ³•ï¼ŒçŒœæµ‹éƒ½æ˜¯å›¾å½¢åˆ¤æ–­æˆ–è€…æ±‰å­—ç‚¹å‡»äº†ã€‚



# 12.é›ªç¢§å›¾åçˆ¬-2

è¯•äº†ä¸‹ç™¾åº¦è¯†å›¾ï¼ˆæ¯å¤©èƒ½å…è´¹ç”¨å¾ˆå¤šæ¬¡ï¼‰ï¼Œå‘ç°ä¾ç„¶ä¼šæœ‰è¯†åˆ«å‡ºé”™çš„æƒ…å†µï¼ï¼ï¼ï¼

æ‰¾äº†ä¸ªç±»ä¼¼çš„ä»£ç ï¼Œè‡ªå·±ä¿®æ”¹äº†éƒ¨åˆ†ï¼Œèƒ½å®ç°è®­ç»ƒå¹¶è¯†åˆ«mnistæ‰‹å†™æ•°å­—ï¼š

```python
"""
    tensorflow2.0å®ç°æ‰‹å†™æ±‰å­—å®ç°: http://blog.itpub.net/69978904/viewspace-2733646/
    ä¿å­˜æ¨¡å‹: https://www.cnblogs.com/piaodoo/p/14124831.html
    æµ‹è¯•tensorflow2å®ç°mnistæ‰‹å†™æ±‰å­—è¯†åˆ«
"""
import os

# ä¸€å®šè¦æ”¾åœ¨ import tensorflow ä¹‹å‰æ‰æœ‰æ•ˆ = =
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2'

from tensorflow import keras
from tensorflow.keras.layers import Flatten, Dense
from tensorflow.keras.datasets import mnist
import numpy as np

# åŠ è½½æ•°æ®é›†
(train_images, train_labels), (test_images, test_labels) = mnist.load_data()

# å›¾ç‰‡æ¯ä¸ªåƒç´ çš„æ•°å€¼éƒ½æ˜¯åœ¨[0, 255]ä¹‹é—´ï¼Œæ‰€ä»¥å½’ä¸€åŒ–è¦é™¤ä»¥255ï¼Œæ•°æ®è¦æ˜¯æµ®ç‚¹æ•°ï¼Œæ‰€ä»¥è¦æ·»åŠ ä¸€ä¸ªå°æ•°ç‚¹
train_images, test_images = train_images / 255.0, test_images / 255.0

"""
    é‡æ–°åˆ›å»ºä¸€ä¸ªmodel
"""
def new_model():
    # å®šä¹‰æ¨¡å‹
    # æ­å»ºä¸€ä¸ªé¡ºåºæ¨¡å‹ï¼Œç¬¬ä¸€å±‚å…ˆå°†æ•°æ®å±•å¹³ï¼ŒåŸå§‹å›¾ç‰‡æ˜¯28x28çš„ç°åº¦å›¾ï¼Œæ‰€ä»¥è¾“å…¥å°ºå¯¸æ˜¯ï¼ˆ28ï¼Œ28ï¼‰ï¼Œç¬¬äºŒå±‚èŠ‚ç‚¹æ•°å¯ä»¥è‡ªå·±é€‰æ‹©ä¸€ä¸ªåˆé€‚å€¼ï¼Œè¿™é‡Œç”¨128ä¸ªèŠ‚ç‚¹ï¼Œæ¿€æ´»å‡½æ•°ç”¨relu
    #   ç¬¬ä¸‰å±‚æœ‰å¤šå°‘ä¸ªç§ç±»å°±å†™å¤šå°‘ï¼Œ[0, 9]ä¸€å…±æœ‰10ä¸ªæ•°å­—,æ‰€ä»¥å¿…é¡»å†™10ï¼Œæ¿€æ´»å‡½æ•°ç”¨softmax
    model = keras.Sequential([
        Flatten(input_shape=(28, 28)),
        Dense(128, activation='relu'),
        Dense(10, activation='softmax')
    ])

    # æŒ‡å®šä¼˜åŒ–å™¨ã€æŸå¤±å‡½æ•°ã€è¯„ä»·æŒ‡æ ‡
    model.compile(optimizer='adam',
                  loss='sparse_categorical_crossentropy',
                  metrics=['acc'])

    return model


"""
    å·²å­˜åœ¨çš„model, åŠ è½½æƒé‡å’Œåç½®(æ–¹æ³•ä¸€: ä¿å­˜æ¨¡å‹çš„æƒé‡å’Œåç½®)
"""
def load_weights_bias(model):
    if os.path.exists('./tensorflow2_mnist_model/weights_bias_model/checkpoint'):
        model.load_weights('./tensorflow2_mnist_model/weights_bias_model/my_model')
    else:
        print('ç¬¬ä¸€æ¬¡ä¿å­˜æƒé‡å’Œåç½®å§? å½“å‰æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨å‘! ')
        return None


"""
    ä¿å­˜modelçš„æƒé‡å’Œåç½®
"""
def save_weight_bias(model):
    model.save_weights('./tensorflow2_mnist_model/weights_bias_model/my_model')


"""
    è®­ç»ƒæ¨¡å‹
"""
def train_model(model):
    # è®­ç»ƒæ¨¡å‹
    model.fit(train_images, train_labels, epochs=1)


"""
    ä¿å­˜æ•´ä¸ªæ¨¡å‹(æ–¹æ³•äºŒ: ç›´æ¥ä¿å­˜æ•´ä¸ªæ¨¡å‹)
"""
def save_all_model(model):
    model.save('./tensorflow2_mnist_model/all_model/mnist_weights.h5')


"""
    åŠ è½½æ•´ä¸ªæ¨¡å‹
"""
def load_all_model():
    if os.path.exists('./tensorflow2_mnist_model/all_model/mnist_weights.h5'):
        return keras.models.load_model('./tensorflow2_mnist_model/all_model/mnist_weights.h5')
    else:
        print('ç¬¬ä¸€æ¬¡ä¿å­˜æ•´ä¸ªæ¨¡å‹å§? å½“å‰æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨å‘! ')
        return None


model = new_model()
# æ–¹æ³•ä¸€: å¼€å§‹
# load_weights_bias(model)
# train_model(model)
# save_weight_bias(model)
# æ–¹æ³•ä¸€: ç»“æŸ

# æ–¹æ³•äºŒ: å¼€å§‹
reload_model = load_all_model()
if reload_model is not None:
    model = reload_model

train_model(model)
save_all_model(model)
# æ–¹æ³•äºŒ: ç»“æŸ


# ç”¨æµ‹è¯•é›†éªŒè¯æ¨¡å‹æ•ˆæœ
test_loss, test_acc = model.evaluate(test_images, test_labels, verbose=2)
print('Test acc:', test_acc)

# å°†å›¾ç‰‡è¾“å…¥æ¨¡å‹ï¼Œè¿”å›é¢„æµ‹ç»“æœ (å°†æµ‹è¯•é›†ä¸­çš„ç¬¬ä¸€å¼ å›¾ç‰‡è¾“å…¥æ¨¡å‹)
predictions = model.predict(test_images)
print('predictions: ', predictions)
print('é¢„æµ‹å€¼:', np.argmax(predictions[0]))
print('çœŸå®å€¼:', test_labels[0])
```



> å…ˆä»¿ç…§mnistæ•°æ®é›†ï¼Œå°†glidedskyä¸Šçš„é›ªç¢§å›¾åˆ†å‰²æˆæ¯ä¸ªå°çš„æ•°å­—ï¼Œä½œä¸ºè®­ç»ƒé›†å›¾ç‰‡ï¼Œä¹‹åå†è¯»å–å›¾ç‰‡ï¼Œæ„æˆmnistæ•°æ®é›†çš„æ•°æ®ç»“æ„ï¼Œå¦‚æ­¤è¾¾åˆ°æœ€ç»ˆèƒ½è¯†åˆ«çš„ç›®çš„ã€‚

## 12.1 æ€è·¯

è®­ç»ƒæ•°æ®ï¼š

åœ¨çº¿è·å–äºŒç»´é›ªç¢§å›¾ï¼Œç”¨psåˆ‡å‰²å¤§çš„äºŒç»´é›ªç¢§å›¾æˆå°æ•°å­—å›¾(https://jingyan.baidu.com/article/9989c746fe0ffef649ecfe5d.html)ï¼Œå¹¶æ‰¹é‡ä¿®æ”¹ä¸º18*18ï¼ˆ**ç™¾åº¦**ï¼šhttps://jingyan.baidu.com/article/9f7e7ec0ecf9676f2815540a.htmlï¼Œå¹¶ä¸”è¦æ±‚ä¸ºæ–‡ä»¶å**ç¬¬ä¸€ä¸ªå­—æ¯æ˜¯æ•°å­—**å³å¯ï¼Œå¦‚'1.12312z.jpg'ã€'3.(1)jpg'

åªä¸è¿‡æ¨ªå‘å‡åŒ€åˆ‡å‰²è¿˜å¥½ï¼Œä½†æ˜¯çºµå‘ä¸è¡Œï¼Œä¼šæ‰“ä¹±æ•°æ®çš„å®Œæ•´æ€§ï¼Œæ‰€ä»¥æœ€å¥½ç”¨ä»£ç ä»¥åƒç´ ä¸ºåŸºå‡†åˆ¤æ–­åˆ‡å‰²å¥½ï¼Œå†ç”¨psç»Ÿä¸€å¤„ç†ä¸º18*18çš„è®­ç»ƒé›†ï¼ˆè¿™ä¸€æ­¥ä¹Ÿèƒ½ç”¨ä»£ç å®Œæˆï¼Œæ‰€ä»¥å»ºè®®ç›´æ¥ç”¨ä»£ç ä¸‹è½½å›¾ç‰‡æ•°æ®é›†ï¼Œæ‰‹åŠ¨æ›´æ”¹æ–‡ä»¶åä½œä¸ºlabelsï¼‰ã€‚



ç°åœ¨åªéœ€ï¼Œå°†æ‰€æœ‰18*18å›¾ç‰‡æ•°æ®è½¬åŒ–ä¸ºç±»ä¼¼mnistçš„æ•°æ®ç»“æ„è¿›è¡Œè¿”å›ï¼š

![image-20210406082822782](ç¬”è®°.assets/image-20210406082822782.png)

imageså’Œlabelsæ•°æ®åˆ†åˆ«æ˜¯ä¸‰ç»´å’Œä¸€ç»´Tensorã€‚

ç„¶åå°±èƒ½ç”¨æœ€ä¸Šæ–¹çš„è®­ç»ƒä»£ç è¿›è¡Œè®­ç»ƒäº†ã€‚

åç»­å†å¤šå¼„ç‚¹æ•°æ®é›†ã€‚

## 12.2 ä»£ç å®ç°åˆ‡å‰²å‡ºå°å›¾

æ¨ªå‘åˆ‡å‰²ï¼Œç»“æœæ˜¯æ¯ä¸€è¡Œï¼Œæ²¡ä¸€è¡Œå†…å†æŒ‰ç…§æ•°å­—æœ€å°å®½åº¦åˆ‡å‰²ï¼Œåˆ‡å‡ºæ¥çš„å›¾ç‰‡å°†åˆ†è¾¨ç‡è°ƒä¸º18*18å°±å¾—åˆ°äº†è®­ç»ƒå›¾ã€‚

æ‰¹é‡é‡å‘½åï¼šå·¦é”®åŠ ä¸Š ctrl ï¼Œå¤šé€‰ï¼Œé€‰å¥½äº†å†å³é”®é‡å‘½åï¼š

![image-20210405203912630](ç¬”è®°.assets/image-20210405203912630.png)

å³é”®é‡å‘½åï¼Œè¾“å…¥â€œ1â€ï¼Œä¸‹å›¾å³ä¸ºç»“æœï¼ˆå¾ˆæ–¹ä¾¿å•Šï¼‰ï¼š



ç”¨ä»¥ä¸‹ä»£ç å¤šç”Ÿæˆå†™è®­ç»ƒé›†ï¼Œå¹¶æ‰¹é‡é‡å‘½åï¼Œæœ‰è€å¿ƒä¸€äº›ã€‚

```python
"""
    ä¸‹è½½äºŒç»´é›ªç¢§å›¾å¹¶å®ç°åˆ†å‰²
"""
from env import Env
import random
import re
from PIL import Image
import base64
import io

# è°ƒç”¨å°è£…çš„ç™»é™†ç¯å¢ƒ
env = Env()
session = env.login()

"""
    è·å–äºŒç»´é›ªç¢§å›¾
"""
def get_sprite(url):
    # è¯·æ±‚æºç 
    response = session.get(url, headers=env.headers)

    # æ­£åˆ™è§£æbase64
    base64_bytes = base64.b64decode(re.search('base64,(.*?)\"', response.text).group(1))

    # å¯ä»¥ä¸ç”¨å†™æ–‡ä»¶, ç›´æ¥è½¬ä¸ºImage
    # with open('./sprite_img/sprite.png', 'wb') as f:
    #     f.write(base64_bytes)

    return Image.open(io.BytesIO(base64_bytes))


"""
    é’ˆå¯¹æ¯ä¸€è¡Œçš„å›¾ç‰‡è¿›è¡ŒæŒ‰åˆ—åˆ‡å‰², è¿”å›æ•°å­—çš„æœ€å°å®½é™é›†åˆ å¦‚ [(1, 3), (5, 8), ...], é‚£ä¹ˆæ¨ªå‘x å±äº [1, 3] å°±æ˜¯æ•°å­—0çš„èŒƒå›´, ä¸€èµ·ç±»æ¨
"""
def get_gray_interval(row_image):
    interval_list = []

    # å‰ä¸€åˆ—çº¯ç™½ ä¸ºçœŸ
    last_col_all_white = True
    # æ•°å­—å¼€å§‹x å’Œ æ•°å­—ç»“æŸx (2ä¸ªå˜é‡ä¸èƒ½è¢«é‡å¤èµ‹å€¼0, æ‰€ä»¥æ”¾åˆ°å¾ªç¯å¤–éƒ¨)
    num_start_x = 0
    num_end_x = 0

    # éå†æ¯ä¸€åˆ—, æ¯ä¸€è¡Œ
    pixels = row_image.load()
    for x in range(row_image.width):
        # å½“å‰åˆ—çº¯ç™½ä¸ºçœŸ
        cur_col_all_white = True
        for y in range(row_image.height):
            # å› ä¸ºæ˜¯ç°åº¦å›¾ç‰‡ åªä»¥ r å€¼ä»£è¡¨é¢œè‰²å³å¯
            if pixels[x, y][0] != 255:
                cur_col_all_white = False

        # ä¸€åˆ—è¿­ä»£ç»“æŸå
        # å¦‚æœ å‰ä¸€åˆ—ä¸ºå…¨ç™½ and å½“å‰åˆ—å­˜åœ¨ç°
        if last_col_all_white and not cur_col_all_white:
            num_start_x = x
        # å¦‚æœ å‰ä¸€åˆ—å­˜åœ¨ç° and å½“å‰åˆ—å…¨ç™½
        if not last_col_all_white and cur_col_all_white:
            num_end_x = x
            # æ·»åŠ åˆ†æ®µä¿¡æ¯
            interval_list.append((num_start_x, num_end_x))

        # ä¸‹ä¸€åˆ—å¼€å§‹å‰, é‡ç½® last_col_all_white
        last_col_all_white = cur_col_all_white

    return interval_list


"""
    åˆ‡å‰²ä¸ºåˆç†å¤§å°, ä¿å­˜åˆ°train_imgæ–‡ä»¶å¤¹ä¸‹, ä½œä¸ºè®­ç»ƒé›†
"""
def slice_image(image):
    # æ¯ä¸€å—çš„é«˜
    piece_height = image.height / 10
    # æ¨ªå‘èƒ½å¹³å‡åˆ‡å‰², çºµå‘ä¸èƒ½, ç”¨psæ¨ªçºµå¹³å‡éƒ½æ˜¯10ä»½è¯•ä¸€ä¸‹å°±çŸ¥é“äº†
    # å…ˆçºµå‘å¹³å‡åˆ‡å‰²10ä»½ 0~9
    for i in range(10):
        y = i * piece_height
        row_image = image.crop((0, y, image.width, y + piece_height))
        # å†å¯¹æ¯ä¸€è¡Œçš„å›¾ç‰‡è¿›è¡ŒæŒ‰åˆ—åˆ‡å‰²
        interval_list = get_gray_interval(row_image)
        # éå†åˆ†éš” æ‰¹é‡åˆ†å‰² ä¿å­˜æ•°å­—å›¾ç‰‡
        for interval in interval_list:
            num_image = row_image.crop((interval[0], 0, interval[1], row_image.height))
            # é‡ç½®åƒç´ ä¸º 18*18 NEAREST: ä½è´¨é‡  BILINEAR: åŒçº¿æ€§: BICUBIC: ä¸‰æ¬¡æ ·æ¡æ’å€¼  ANTIALIAS: é«˜è´¨é‡  æ„Ÿè§‰ä¸­é—´ä¸¤ä¸ªæ•ˆæœå¥½ä¸€äº›
            num_image = num_image.resize((18, 18), Image.ANTIALIAS)
            # æš‚æ—¶éšæœºå–å ä¹‹åå†æ‰‹åŠ¨è°ƒæ•´ä¸ºçœŸå®æ•°å­—å‘½åæ–‡ä»¶
            num_image.save(f'./train_img/{random.randint(11, 1000)}.png')


url = 'http://www.glidedsky.com/level/web/crawler-sprite-image-2?page=1'
image = get_sprite(url)
slice_image(image)
```



æš‚æ—¶å¼„è¿™ä¹ˆå¤šè®­ç»ƒé›†ï¼š![image-20210405211432812](ç¬”è®°.assets/image-20210405211432812.png)

å†å¼„è¿™ä¹ˆå¤šæµ‹è¯•é›†ï¼š

![image-20210405211944514](ç¬”è®°.assets/image-20210405211944514.png)



## 12.3 å¼€å§‹è®­ç»ƒ

è¯»å–è¿›å»çš„æ–‡ä»¶ååˆ—è¡¨ï¼Œä¸€å®šè®°å¾—shuffleä¸€ä¸‹ã€‚

å¤šè®­ç»ƒäº›æ•°æ®é›†ï¼Œå¦‚æœå¯¹æµ‹è¯•ç»“æœä¸æ»¡æ„å†é‡æ–°`æ·»åŠ äº›è®­ç»ƒé›†`å³å¯ã€‚

= =ï¼Œæœ‰äº›æ•°å­—å½¢çŠ¶ä¹Ÿå¤ªç¦»è°±äº†å§

![image-20210406084426303](ç¬”è®°.assets/image-20210406084426303.png)



## 12.4 ç¼–ç 

æŠŠbase64ä¸²å’Œé¢„æµ‹ç»“æœè®°å½•ï¼Œæ¯”è¾ƒï¼Œå°†`ä¸åŒçš„æ•°å­—`ä¿å­˜ä¸ºè®­ç»ƒé›†ï¼Œå†æ¬¡è®­ç»ƒã€‚

![image-20210406095605329](ç¬”è®°.assets/image-20210406095605329.png)

æŠŠæ„Ÿè§‰åˆ¤æ–­ä¸å¥½çš„æ•°å­—ä¹Ÿä¸€å¹¶åŠ å…¥è®­ç»ƒé›†ã€‚

1ã€2ã€7ã€4ã€6ã€3æ˜¯é«˜é¢‘é”™ç‚¹ï¼Œéƒ½å…¨éƒ¨åŠ å…¥è®­ç»ƒé›†ã€‚

![image-20210406100953635](ç¬”è®°.assets/image-20210406100953635.png)



åå¤é‡å¤ä»¥ä¸Šå¯¹æ¯”æ“ä½œã€æ·»åŠ æ•°æ®é›†é‡æ–°è®­ç»ƒæ“ä½œã€‚

![image-20210406101700408](ç¬”è®°.assets/image-20210406101700408.png)

è¿™ã€‚ã€‚ï¼Œè®­ç»ƒé›†å¤ªå°‘äº†å§ï¼Ÿ = =

å†åŠ ç‚¹ï¼š

![image-20210406102453451](ç¬”è®°.assets/image-20210406102453451.png)

æŒ‰è¿™æ ·æ¯è¡Œ10ä¸ªåŒºåˆ†èµ·æ¥ä¼šå¿«é€Ÿäº›ã€‚

æ¥ä¸‹æ¥å°±æ˜¯ä¸æ–­è®­ç»ƒçš„è¿‡ç¨‹äº†ã€‚

![image-20210406103353914](ç¬”è®°.assets/image-20210406103353914.png)

![image-20210406104519624](ç¬”è®°.assets/image-20210406104519624.png)



è¿™ä¸ª `6`  å°±ç¦»è°±

![image-20210406104843291](ç¬”è®°.assets/image-20210406104843291.png)





> ä¹‹åæ‰æ„è¯†åˆ°ï¼Œç›´æ¥è·å–ç¬¬ä¸€é¡µæ•°æ®ï¼Œå› ä¸ºæ•°å­—å›ºå®šï¼Œèƒ½ç›´æ¥è·å¾—çœŸå®æ•°å­—å’Œ `small_image` çš„å¯¹åº”å…³ç³»ã€‚
>
> https://www.cnblogs.com/TurboWay/p/13678074.html

è®­ç»ƒæ•°æ®ï¼š

![image-20210406132819712](ç¬”è®°.assets/image-20210406132819712.png)

æµ‹è¯•æ•°æ®ï¼š

![image-20210406132838878](ç¬”è®°.assets/image-20210406132838878.png)

æˆ‘é ï¼Œresizeéœ€è¦é‡æ–°èµ‹å€¼ï¼Œæ²¡é‡æ–°èµ‹å€¼å°±ä¿å­˜äº†ï¼å…¨æ˜¯æ¯resizeä¹‹å‰çš„å›¾ç‰‡ï¼Œéƒ½å¾—é‡æ–°ä¸‹è½½

æ–°æ•°æ®ï¼š

![image-20210407080409861](ç¬”è®°.assets/image-20210407080409861.png)

é‡æ–°è®­ç»ƒã€‚

ç„¶åæ¯é¡µæ•°æ®çš„å’Œï¼Œè¯·æ±‚æ¬¡æ•°åœ¨3æ¬¡åŠå…¶ä»¥ä¸Šï¼Œå¹¶ä¸”æœ‰ä¸ªæ•°é¢‘ç‡å¤§äºç­‰äº3/4ï¼Œæ‰ç®—è¯·æ±‚æˆåŠŸï¼Œå¦åˆ™é‡æ–°è¯·æ±‚å½“å‰é¡µæ•°æ®ã€‚



> è¯´æ˜ï¼šåç»­æ·»åŠ è®­ç»ƒæ•°æ®åˆ°è¾¾42wï¼Œåº”è¯¥åœ¨10wéƒ½å¤Ÿäº†ï¼Œæˆ‘è¿˜ä»¥ä¸ºè®­ç»ƒå‡ºé”™ï¼Œå¤šå¼„äº†äº›æ•°æ®
>
> è¿˜æœ‰ï¼Œå³ä½¿accuracyè¾¾åˆ°0.98/0.97ï¼ˆæµ‹è¯•é›†æœ‰10wï¼‰ï¼Œå®é™…çˆ¬å–æ—¶å‡ºé”™æ¦‚ç‡ä¾æ—§ç‰¹åˆ«é«˜ï¼Œä¸€å®šè¦ä¸€ä¸ªé¡µé¢å¤šè¯·æ±‚å‡ ç»„ï¼Œå–é«˜é¢‘å‡ºç°çš„é‚£ä¸ªåˆ¤å®šæ•°æ®ï¼ï¼ï¼



> ä»£ç 

```python
"""
çˆ¬è™«-é›ªç¢§å›¾-2
"""
import os
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2'

from env import Env
from lxml import etree
import re
from PIL import Image
import base64
import io
import numpy as np
from tensorflow import keras
import tensorflow as tf

# è°ƒç”¨å°è£…çš„ç™»é™†ç¯å¢ƒ
env = Env()
session = env.login()


"""
    è·å–äºŒç»´é›ªç¢§å›¾(åŒ 2.sprite2_base64img_download.py)
    context: ç½‘é¡µæºç 
"""
def get_sprite(context):
    # æ­£åˆ™è§£æbase64
    base64_bytes = base64.b64decode(re.search('base64,(.*?)\"', context).group(1))

    # å¯ä»¥ä¸ç”¨å†™æ–‡ä»¶, ç›´æ¥è½¬ä¸ºImage
    # with open('./sprite_img/sprite.png', 'wb') as f:
    #     f.write(base64_bytes)

    return Image.open(io.BytesIO(base64_bytes))


"""
    é’ˆå¯¹æ¯ä¸€è¡Œçš„å›¾ç‰‡è¿›è¡ŒæŒ‰åˆ—åˆ‡å‰², è¿”å›æ•°å­—çš„æœ€å°å®½é™é›†åˆ å¦‚ [(1, 3), (5, 8), ...], é‚£ä¹ˆæ¨ªå‘x å±äº [1, 3] å°±æ˜¯æ•°å­—0çš„èŒƒå›´, ä¸€èµ·ç±»æ¨
    (åŒ 2.sprite2_base64img_download.py)
"""
def get_gray_interval(row_image):
    interval_list = []

    # å‰ä¸€åˆ—çº¯ç™½ ä¸ºçœŸ
    last_col_all_white = True
    # æ•°å­—å¼€å§‹x å’Œ æ•°å­—ç»“æŸx (2ä¸ªå˜é‡ä¸èƒ½è¢«é‡å¤èµ‹å€¼0, æ‰€ä»¥æ”¾åˆ°å¾ªç¯å¤–éƒ¨)
    num_start_x = 0
    num_end_x = 0

    # éå†æ¯ä¸€åˆ—, æ¯ä¸€è¡Œ
    pixels = row_image.load()
    for x in range(row_image.width):
        # å½“å‰åˆ—çº¯ç™½ä¸ºçœŸ
        cur_col_all_white = True
        for y in range(row_image.height):
            # å› ä¸ºæ˜¯ç°åº¦å›¾ç‰‡ åªä»¥ r å€¼ä»£è¡¨é¢œè‰²å³å¯
            if pixels[x, y][0] != 255:
                cur_col_all_white = False

        # ä¸€åˆ—è¿­ä»£ç»“æŸå
        # å¦‚æœ å‰ä¸€åˆ—ä¸ºå…¨ç™½ and å½“å‰åˆ—å­˜åœ¨ç°
        if last_col_all_white and not cur_col_all_white:
            num_start_x = x
        # å¦‚æœ å‰ä¸€åˆ—å­˜åœ¨ç° and å½“å‰åˆ—å…¨ç™½
        if not last_col_all_white and cur_col_all_white:
            num_end_x = x
            # æ·»åŠ åˆ†æ®µä¿¡æ¯
            interval_list.append((num_start_x, num_end_x))

        # ä¸‹ä¸€åˆ—å¼€å§‹å‰, é‡ç½® last_col_all_white
        last_col_all_white = cur_col_all_white

    return interval_list


"""
    å°†å›¾ç‰‡åˆ—è¡¨è½¬ä¸ºç±»ä¼¼mnistæ•°æ®ç»“æ„çš„æ•°æ®, æ–¹ä¾¿æ¨¡å‹è¿›è¡Œé¢„æµ‹
    return: [100*18*18] ä¸‰ç»´çŸ©é˜µTensor
        åŸºæœ¬åŒ 3.sprite2_train_test.py ä¸­çš„ def get_train_data_like_mnist(train_img_path)
"""
def parse_images_like_mnist_data(small_images):
    # å‡†å¤‡ä¸‰ç»´çŸ©é˜µ
    images = np.zeros([len(small_images), 18, 18])

    # éå†æ¯ä¸ªåƒç´ ç‚¹
    for index, small_image in enumerate(small_images):
        # éå†æ¯ä¸ªå›¾ç‰‡çš„æ‰€æœ‰åƒç´ ç‚¹
        width = 18
        height = 18
        for x in range(0, width):
            for y in range(0, height):
                # å•é€šé“å– rå€¼ å³å¯  æ„å»º[b, 18, 20]  ä¿è¯ç°åº¦å€¼åœ¨ 0~1
                images[index][x][y] = small_image.getpixel((x, y))[0] / 255.0

    # è¿”å›è®­ç»ƒæ•°æ®æ—¶, éœ€è¦å°†æ•°æ®å°è£…ä¸ºTensor
    return tf.convert_to_tensor(images, dtype=tf.float32)


"""
    é¢„æµ‹æ•°å­—
    return: è¿”å›æ•°å­—åˆ—è¡¨(strå½¢å¼, åæœŸæ–¹ä¾¿æ‹¼æ¥)
"""
def predict(small_images, model):
    # numè¡¨ç¤ºæ¯ä¸€é¡µæ•°æ® å°±æ˜¯12ä¸ª
    num_list = []

    images_data = parse_images_like_mnist_data(small_images)
    # è¿›è¡Œé¢„æµ‹ predictions æ˜¯é¢„æµ‹çš„æ¦‚ç‡å€¼
    predictions = model.predict(images_data)

    # é¢„æµ‹å€¼å¡«å……è¿› num_list
    for i in range(0, len(small_images)):
        # å°†int64è½¬ä¸ºint
        num_list.append(np.argmax(predictions[i]))

    return num_list


"""
    æ ¹æ®æ¯ä¸ªå•æ•°å­—divçš„åç§»å’Œå®½é«˜ä»é›ªç¢§å›¾ä¸­åˆ‡å‰²å‡ºå°å›¾, åˆ©ç”¨æ¨¡å‹è¯†åˆ«æ•°å­—
    image: äºŒä½é›ªç¢§å›¾
    context: ç½‘é¡µæºç 
    return: (åˆ‡å‰²å¥½çš„ single_bit_imageé›†åˆ, ä¸€é¡µå…±12ä¸ªæ•°æ¯ä¸ªæ•°æœ‰å‡ ä½æ•°å­—)
"""
def slice_image(image, context):
    # æ¯ä¸€ä½æ•°å­—çš„é›†åˆ
    single_bit_images = []
    # è®°å½•æ€»å…±12ä¸ªæ•°å­— æ¯ä¸ªæ•°å­—å„æœ‰å¤šå°‘ä½
    count_bit = []

    # è·å–è£…æœ‰æ•°å­—çš„div
    html = etree.HTML(context)
    num_divs = html.xpath('//div[@class="col-md-1"]')
    # è·å–css
    style = html.xpath('//style/text()')[0]

    # éå†div(ä¸€æ•´ä¸ªæ•°å­—)
    for num_div in num_divs:
        # è®°å½•è¿™ä¸ªæ•°å­—æœ‰å¤šå°‘ä½
        count = 0
        # éå†æ¯ä¸€ä½æ•°å­—çš„æ¯ä¸€ä½
        for single_bit_div in num_div:
            # è·å–æ ·å¼

            clazz = single_bit_div.attrib['class']
            clazz = clazz[:clazz.index(' ')]
            # ä»styleæŸ¥è¯¢ offset-x offset-y width height
            offset_x = abs(int(re.search(clazz + ' \\{ background-position-x:(-?\\d+)px', style).group(1)))
            offset_y = abs(int(re.search(clazz + ' \\{ background-position-y:(-?\\d+)px', style).group(1)))
            width = abs(int(re.search(clazz + ' \\{ width:(\\d+)px', style).group(1)))
            height = abs(int(re.search(clazz + ' \\{ height:(\\d+)px', style).group(1)))

            # åˆ‡å‰² é›ªç¢§å›¾ä¸­è¿™ä¸ªåç§»å’Œå®½é«˜å¯¹åº”çš„å›¾ç‰‡ å°±æ˜¯å½“å‰æ•°å­—çš„å›¾
            single_bit_image = image.crop((offset_x, offset_y, offset_x + width, offset_y + height))

            # resize
            single_bit_image = single_bit_image.resize((18, 18), Image.ANTIALIAS)

            # åŠ å…¥å•ä½æ•°å­—
            single_bit_images.append(single_bit_image)
            count += 1

        # è®°å½•ä¸‹è¿™ä¸ªæ•°å­—çš„ä½æ•°
        count_bit.append(count)

    return single_bit_images, count_bit


"""
    æ ¹æ®æ¯ä¸€ä¸ªå°æ•°å­— å’Œ æ¯ä¸ªå¤§æ•°å­—å çš„ä½æ•° çš„åˆ°å¤§æ•°å­—é›†åˆ
"""
def mix_num(single_num_list, count_bit):
    index = 0
    # ç»“æœ
    num_list = []

    for bit in count_bit:
        num = 0
        # æŒ‰ç…§ä½æ•° é¡ºåºæ‹¼æ¥æ¯ä¸€ä½ å¾ªç¯æ¬¡æ•°æ˜¯bitæ¬¡
        while bit:
            num += single_num_list[index] * (10 ** (bit - 1))
            index += 1
            bit -= 1

        # å¡«å…¥
        num_list.append(num)

    return num_list


"""
    è¯·æ±‚è¿”å›å½“å‰é¡µæ•°å­—é›†åˆ
"""
def get_num_list(page_num, model):
    url = f'http://www.glidedsky.com/level/web/crawler-sprite-image-2?page={page_num}'

    response = session.get(url, headers=env.headers)

    # ä¸€å¼  2ç»´é›ªç¢§å›¾
    sprite_image = get_sprite(response.text)
    # åˆ†å‰²æˆçš„ 18*18 å°å›¾
    single_bit_images, count_bit = slice_image(sprite_image, response.text)

    # æ¨æµ‹é›ªç¢§å›¾ä¸­çš„çœŸå®æ•°å­— å¾—åˆ°æ•°å­—åˆ—è¡¨
    num_list = predict(single_bit_images, model)

    # æ ¹æ®åˆ—è¡¨å’Œæœ‰å‡ ä½æ•°å­—è·å¾—çœŸå®æ•°å­—é›†åˆ
    num_list = mix_num(num_list, count_bit)
    # print(f'ç¬¬ {page_num} é¡µçš„æ¯ä¸ªæ•°å­—: ', num_list)

    return num_list


"""
    åˆ¤æ–­é¢„æµ‹æ˜¯å¦ç²¾ç¡®
"""
def is_accurate(predicts):
    # = =, æ¨¡å‹åˆ¤æ–­ç‡æŒºé«˜çš„äº†(éƒ½42wè®­ç»ƒé›†äº†), åŒä¸€é¡µè¯·æ±‚çš„å‰ä¸‰æ¬¡éƒ½ç›¸åŒç›´æ¥å°±è¿”å›äº†(å³åˆ¤å®šå‡†ç¡®ç»“æœéƒ½è¿˜æœ‰é”™) éš¾é“å­˜åœ¨è¿ç»­3æ¬¡éƒ½åˆ¤é”™çš„å¯èƒ½?
    # if len(predicts) < 3:
    if len(predicts) < 6:
        return False

    predicts_set = set(predicts)
    # çœ‹é¢„æµ‹ç»“æœå‡ºç°çš„é¢‘ç‡ è®¤å®šå‡ºç°é¢‘ç‡ >= 2/3 é‚£ä¹ˆè¿™ä¸ªæ•°æ‰æ˜¯å‡†ç¡®çš„(å› ä¸ºæœ¬èº«æ¨¡å‹ç¡®è®¤ç‡è™½ç„¶æ¥è¿‘100% ä½†ä¸æ˜¯100%)
    # ç»Ÿè®¡ { æ•°å­—: å‡ºç°çš„æ¬¡æ•° }
    statistics = {num: predicts.count(num) for num in predicts_set}

    # å€¼é€†åºæ’åˆ— è¿”å›åˆ—è¡¨ ä¸€å¯¹é”®å€¼æ··åˆä¸ºå…ƒç»„
    statistics = sorted(statistics.items(), key=lambda x: x[1], reverse=True)
    # å€¼æœ€å¤§çš„å…ƒç»„ çš„ç¬¬äºŒä¸ªå…ƒç´  æ‰æ˜¯ é¢‘æ•°, å…ƒç»„ç¬¬ä¸€ä¸ªæ˜¯æ•°å­—å’Œ
    # ä¸ç”¨è¿™ä¸ªæ¡ä»¶äº† = =, å¤ªå¤šé¢„æµ‹é”™è¯¯çš„å°±ä¼šä¸€ç›´å¡åœ¨å½“å‰é¡µäº† æ°¸è¿œè¾¾ä¸åˆ°è¿™ä¸ªæ¯”ä¾‹
    # if statistics[0][1] / len(predicts) >= 3 / 4:

    # é‡‡ç”¨ åªæœ‰é¢‘ç‡1å‡ºç° or é¢‘ç‡top1 / top2 > n æˆ‘è§‰å¾—4å¤Ÿé«˜äº†å•Š
    if len(statistics) == 1 or statistics[0][1] / statistics[1][1] > 4:
        print(statistics)
        return statistics[0][0]
    else:
        return False


if __name__ == '__main__':
    total = 0

    # æ¨¡å‹æ–‡ä»¶è·¯å¾„
    model_path = './sprite-image-2-test/glided_sky_model/glided_sky_model.h5'
    # åŠ è½½æ¨¡å‹(æ”¾åˆ°å‡½æ•°é‡ŒåŠ è½½æŠ¥WARNING, è§£å†³ä¸äº†: ARNING:tensorflow:6 out of the last 11 calls to <function
    #       Model.make_predict_function.)
    restored_model = keras.models.load_model(model_path)

    for i in range(1, 1001):
        # å½“å‰é¡µçš„é¢„æµ‹å€¼é›†åˆ
        predicts = []

        print('-' * 100)
        # ç»“æœæ˜¯å¦å‡†ç¡®
        accurate = is_accurate(predicts)
        count = 0
        while not accurate:
            count += 1
            # ä¸ç²¾ç¡® å°±é‡æ–°è¯·æ±‚
            num_list = get_num_list(i, restored_model)
            predicts.append(sum(num_list))
            accurate = is_accurate(predicts)

        print(f'ç»è¿‡ {count} è½®è®¡ç®—, ç»“æœæ‰ç²¾ç¡®!!!')
        # åˆ¤æ–­æ•°å€¼æ˜¯å¦ç²¾ç¡® è¿™é‡Œaccurateæ˜¯int64çš„, æºäºç”¨æ¨¡å‹é¢„æµ‹æ—¶ np.argmax() ç»“æœæ˜¯ int64
        print(f'ç¬¬ {i} é¡µæ•°æ®ä¸º: {num_list}, æ±‚å’Œæ˜¯ {accurate}')

        total += accurate
        print(f'å‰ {i} é¡µ, æ•°å­—å’Œä¸º {total}')
        print('-' * 100)

"""
    page1 [337, 379, 263, 144, 131, 285, 381, 364, 291, 171, 110, 94]
    page1 + page2 + page3 = 2956 + 2907 + 2844 = 8707
    
    é”™è¯¯ç­”æ¡ˆ1: 2725233
    é”™è¯¯ç­”æ¡ˆ2: 2724715
    è¿˜çœŸæ˜¯å‡ºé”™å‡ºåœ¨è¿ç»­ä¸‰æ¬¡éƒ½åˆ¤å®šä¸ºé”™è¯¯ç­”æ¡ˆ!!! ä¿®æ”¹ä¸º6æ¬¡ä»¥ä¸Šæ‰åˆ¤å®šå°±å¥½äº†(å¤šåˆ¤å®šå‡ ç»„æ•°æ®) (æ­£ç¡®ç­”æ¡ˆ: 27247^_^)
    ä¹‹å‰è¿˜æ€€ç–‘è®­ç»ƒ42wç»„æ•°æ®éƒ½èƒ½å‡ºé”™ (*ï¿£â–½ï¿£*)
"""
```

























